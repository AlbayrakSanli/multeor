var Destroyable=function(a,b,c,d,e,h,f){this.props={id:a,image:b,x:c,y:d,frameWidth:e?b.width/8:b.width,frameHeight:e?b.height/2:b.height,destroyable:e,destroyedColorIndex:h,currentSpriteFrame:f}};
Destroyable.prototype.draw=function(a,b){this.props.destroyedColorIndex?a.drawImage(this.props.image,this.props.frameWidth*(this.props.destroyedColorIndex-1),this.props.frameHeight,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):a.drawImage(this.props.image,this.props.frameWidth*(this.props.currentSpriteFrame-1),0,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight)};
Destroyable.prototype.collides=function(a,b){var c=this.props.x,d=c+this.props.frameWidth,e=this.props.y,h=e+this.props.frameHeight;context.fillRect(c,e,d-c,h-e);for(player in a){var f=a[player].props.x-10+80,k=a[player].props.x+10+80,g=a[player].props.y+10,l=a[player].props.y-10;context.fillRect(k,g,f-k,l-g);if(f>=c&&k<=d&&g>=e&&l<=h)return player}return!1};var Game=function(a,b){var c=this;c.props={state:"LOADING",message:!1,defaultText:"Go to http://game.multeor.com on your mobile and enter code "+b+" to join",preloadImages:[],audio:{},images:[],world:!1,worldX:0,worldSpeed:10,destroyed:{},levelPath:a,spriteAnimationDirection:"forwards",spriteAnimationStep:0.1,spriteAnimationFrame:1};$.ajaxSetup({cache:!0});$.getJSON(c.props.levelPath+"/level.json",function(a){c.message("Loading");c.props.world=a;for(var b=0;b<a.length;b++)if("undefined"!=typeof a[b].background&&
c.props.preloadImages.push(a[b].background),a[b].sprites.length)for(var h=0;h<a[b].sprites.length;h++){var f=a[b].sprites[h];"undefined"!=typeof f.path&&-1===$.inArray(f.path,c.props.preloadImages)&&c.props.preloadImages.push(f.path);"undefined"!=typeof f.audio&&"undefined"==typeof c.props.audio[f.audio]&&"none"!=f.audio&&(c.props.audio[f.audio]=null)}console.log("Preloading: "+c.props.preloadImages);for(a=0;a<c.props.preloadImages.length;a++)c.loadImage(c.props.preloadImages[a]);c.loadAudio()}).fail(function(a,
b,c){throw c;})};
Game.prototype.loadAudio=function(){var a=new Howl({urls:[this.props.levelPath+"/audio/level.mp3",this.props.levelPath+"/audio/level.ogg"],loop:!0});$(window).off("game-audio-start").on("game-audio-start",function(b){b={volume:0};a.volume(b.volume);a.play();$(b).animate({volume:1},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)}})});$(window).off("game-audio-stop").on("game-audio-stop",function(b){$({volume:1}).animate({volume:0},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)},
complete:function(){a.stop()}})});for(var b in this.props.audio)this.props.audio[b]=new Howl({urls:[this.props.levelPath+"/audio/sprites/"+b+".mp3",this.props.levelPath+"/audio/sprites/"+b+".ogg"]})};
Game.prototype.tick=function(a){if("LOADING"==this.props.state)return!1;context.clearRect(0,0,canvas.width,canvas.height);if("STARTED"==this.props.state||"LEADERBOARD"==this.props.state)this.props.worldX<1E3*this.props.world.length-canvas.width?this.props.worldX+=this.props.worldSpeed:this.endGame();a=Math.ceil(canvas.width/1E3);var b=Math.floor(this.props.worldX/1E3),c=this.props.worldX%1E3;this.renderBackgrounds(a,b,c);this.renderEntities(a,b,c);this.props.message.length&&this.renderText();"STARTED"==
this.props.state&&this.props.worldX>1E3*this.props.world.length-7E3&&(this.props.state="LEADERBOARD",this.renderToLeaderboard());("ENDED"==this.props.state||"LEADERBOARD"==this.props.state)&&this.renderLeaderboard()};
Game.prototype.renderBackgrounds=function(a,b,c){for(var d=0;d<=a;d++){var e=this.props.world[b+d];if("undefined"!=typeof e){var e=this.getImage(e.background),h=1E3*d-c,f=0,k=1E3;0>h&&(h=0,f=c,k=1E3-c);h+1E3>canvas.width&&(k=canvas.width-h);"undefined"!=typeof e&&context.drawImage(e,f,0,k,canvas.height,h,0,k,canvas.height)}}};
Game.prototype.renderEntities=function(a,b,c){var d=[],e=0;"forwards"===this.props.spriteAnimationDirection?this.props.spriteAnimationFrame<9-this.props.spriteAnimationStep?this.props.spriteAnimationFrame+=this.props.spriteAnimationStep:this.props.spriteAnimationDirection="backwards":this.props.spriteAnimationFrame>1+this.props.spriteAnimationStep?this.props.spriteAnimationFrame-=this.props.spriteAnimationStep:this.props.spriteAnimationDirection="forwards";for(var h=Math.floor(this.props.spriteAnimationFrame),
f=0;f<=a;f++){var k=this.props.world[b+f];if("undefined"!=typeof k)for(sprite in k.sprites){var g=k.sprites[sprite],l=this.props.destroyed[g.id]||!1,m=1E3*f-c+g.left,p=g.top,n=e+1E3*g.layer;g.left-=2*(g.layer-1);d[n]=new Destroyable(g.id,this.getImage(g.path),m,p,g.destroyable,l,h);g.destroyable&&!l&&(l=d[n].collides(players,c),!1!==l&&(m=$.inArray(players[l].props.color,playerColors)+1,this.props.destroyed[g.id]=m,0<g.score&&(players[l].updateScore(g.score),g.audio&&"none"!=g.audio&&this.props.audio[g.audio].volume(0.2).play())));
e++}}for(player in players)n=1E3*players[player].props.layer+900+players[player].props.playerNumber,d[n]=players[player];for(key in d)d[key].draw(context,c)};Game.prototype.renderText=function(){var a=canvas.width/2;this.drawMessage(context,this.props.message,(canvas.width-a)/2,canvas.height/2.2,a,35,!0)};
Game.prototype.renderToLeaderboard=function(){var a=0,b=[];for(player in players)players[player].lockPlayer(),players[player].props.score>a&&(a=players[player].props.score),b.push([players[player],players[player].props.score]);b.sort(function(a,b){return b[1]-a[1]});logGAEvent("Ended","Highest score",a);var c=0,d=canvas.width/4;for(player in b){var e=b[player][0];c++;e.props.endX=Math.floor(e.props.score/a*(canvas.width/2+d));e.props.endX<canvas.width/2-d&&(e.props.endX=canvas.width/2-d);e.props.endY=
Math.floor(c*(e.props.minZ+30)+70)}};
Game.prototype.renderLeaderboard=function(){var a=canvas.width/2;this.drawMessage(context,"SCORES",(canvas.width-a)/2,70,a,35,!0);for(player in players)players[player].props.x<players[player].props.endX+10&&players[player].props.x>players[player].props.endX-10&&players[player].props.y<players[player].props.endY+10&&players[player].props.y>players[player].props.endY-10&&this.drawMessage(context,players[player].props.score,players[player].props.endX+130,players[player].props.endY+9,a,35,!1)};
Game.prototype.message=function(a){this.props.message=a};Game.prototype.loadImage=function(a){if("undefined"==typeof this.props.images[a]){var b=this,c=new Image;c.src=this.props.levelPath+a;c.onload=function(){b.props.images[a]={width:this.width,height:this.height,image:this};b.props.preloadImages.length>=b.props.images.length&&(b.props.state="WAITING",b.message(b.props.defaultText))};c.onerror=function(){throw"image "+a+" not found";}}};Game.prototype.getImage=function(a){if("undefined"!=typeof this.props.images[a])return this.props.images[a].image};
Game.prototype.resetGame=function(){this.props.worldX=0;this.props.state="WAITING";this.message(this.props.defaultText);this.props.destroyed=[];players={};socket.emit("game-reset",{viewerId:viewerId,gameRoom:gameRoom});clearInterval(getReadyInterval)};
Game.prototype.abortGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ABORTED";$(window).trigger("game-audio-stop");a.message("Game aborted!");logGAEvent("Aborted");setTimeout(function(){a.resetGame()},2E3)};Game.prototype.endGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ENDED";$(window).trigger("game-audio-stop");setTimeout(function(){a.resetGame()},1E4)};
Game.prototype.getReady=function(){var a=this;if("WAITING"!=a.props.state)return!1;$(window).trigger("game-audio-start");a.props.state="GETREADY";socket.emit("game-get-ready",{viewerId:viewerId,gameRoom:gameRoom});var b=10,c=setInterval(function(){if("GETREADY"!=a.props.state)return clearInterval(c),!1;1>b?(a.message("GO!"),clearInterval(c),setTimeout(function(){a.message("");a.startGame()},1E3)):(a.message("Game starting in "+b+" seconds, get ready..."),b--)},1E3)};
Game.prototype.startGame=function(){if("GETREADY"!=this.props.state)return!1;this.props.state="STARTED";socket.emit("game-start",{viewerId:viewerId,gameRoom:gameRoom});var a=0,b;for(b in players)a++;logGAEvent("Started","Players",a)};
Game.prototype.drawMessage=function(a,b,c,d,e,h,f){a.save();a.font="30px ablas_altbold";a.fillStyle="#FFFFFF";b=b.toString().split(" ");for(var k="",g=0;g<b.length;g++){var l=k+b[g]+" ",m=a.measureText(l).width;m>e?(a.fillText(k,c,d),k=b[g]+" ",d+=h):(f&&(c=canvas.width/2-m/2),k=l)}a.fillText(k,c,d);a.restore()};var Player=function(a,b,c,d,e){this.props={playerId:a,playerNumber:e,x:0,y:0,z:0,vector:[0,0,0],minX:60,maxX:b-180,minY:60,maxY:c-60,minZ:60,maxZ:120,color:d,lastMoves:[],score:0,angle:0,locked:!1,endX:0,endY:0,endZ:60,layer:1};this.props.y=e*(this.props.minZ+18)};
Player.prototype.draw=function(a){this.updatePosition();if(9<this.props.lastMoves.length){var b=this.props.lastMoves[0][1],c=this.props.lastMoves[6][0],d=this.props.lastMoves[6][1],e=this.props.lastMoves[7][0],h=this.props.lastMoves[7][1],f=100+this.props.lastMoves[9][0],k=this.props.lastMoves[9][1];a.lineWidth=this.props.z;var g=a.createLinearGradient(0,0,f-a.lineWidth/2,0);g.addColorStop(1,this.props.color);g.addColorStop(0,"rgba(0,0,0,0)");a.strokeStyle=g;a.lineCap="round";a.beginPath();a.moveTo(0,
b);a.bezierCurveTo(c,d,e,h,f,k);a.stroke();b=players[player].props.x-10;c=players[player].props.x+10;d=players[player].props.y+10;e=players[player].props.y-10;a.save();a.fillStyle="rgba(0,0,0,.6)";a.translate(f,k);this.props.angle++;a.rotate(Math.PI/180*this.props.angle);a.fillRect(10,10,b-c,e-d);a.restore()}};
Player.prototype.updatePosition=function(){if(this.props.lock)this.props.x+2<this.props.endX&&(this.props.x+=2),this.props.y+2<this.props.endY&&(this.props.y+=2),this.props.z+0.5<this.props.endZ&&(this.props.z+=0.5),this.props.x-2>this.props.endX&&(this.props.x-=2),this.props.y-2>this.props.endY&&(this.props.y-=2),this.props.z-0.5>this.props.endZ&&(this.props.z-=0.5);else{var a=ySpeed=0.1,b=this.props.vector[0]*(Math.PI/180);90<this.props.vector[0]&&270>this.props.vector[0]&&(a*=2);this.props.x+=
Math.cos(b)*this.props.vector[1]*a;this.props.x>this.props.maxX&&(this.props.x=this.props.maxX);this.props.x<this.props.minX&&(this.props.x=this.props.minX);this.props.y+=Math.sin(b)*this.props.vector[1]*ySpeed;this.props.y>this.props.maxY&&(this.props.y=this.props.maxY);this.props.y<this.props.minY&&(this.props.y=this.props.minY);this.props.z-3>this.props.vector[2]?this.props.z-=3:this.props.z+3<this.props.vector[2]&&(this.props.z+=3);this.props.z>this.props.maxZ&&(this.props.z=this.props.maxZ);
this.props.z<this.props.minZ&&(this.props.z=this.props.minZ)}this.props.lastMoves.push([this.props.x,this.props.y]);10<this.props.lastMoves.length&&this.props.lastMoves.shift()};Player.prototype.updateScore=function(a){this.props.score+=a;socket.emit("update-score",{viewerId:viewerId,gameRoom:gameRoom,playerId:this.props.playerId,score:this.props.score})};Player.prototype.lockPlayer=function(){this.props.lock=!0};var socket=io.connect(window.location.hostname+":3333"),canvas=document.getElementById("canvas");canvas.width=$(window).width();canvas.height=600;
var context=canvas.getContext("2d"),players={},getReadyInterval=!1,game=!1,playerColors="rgba(255,0,36,0.8) rgba(8,103,255,0.8) rgba(255,110,221,0.8) rgba(255,255,0,0.8) rgba(110,8,157,0.8) rgba(0,255,247,0.8) rgba(16,230,34,0.8) rgba(255,174,26,0.8)".split(" "),playerColorsShuffled=shuffleArray(playerColors.slice(0)),gameRoom=sessionStorage.getItem("game-room")||Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("game-room",gameRoom);
var viewerId=sessionStorage.getItem("viewer-id")||Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("viewer-id",viewerId);
$(document).ready(function(){var a=new Game("/levels/forest",gameRoom);socket.emit("new-viewer",{viewerId:viewerId,gameRoom:gameRoom});socket.on("game-end",function(b){a.abortGame()});socket.on("game-invalid",function(a){sessionStorage.setItem("viewer-id","");sessionStorage.setItem("game-room","");alert("Sorry, no game hijacking");document.location="/";logGAEvent("Room hijacking?")});socket.on("update-game-state",function(b){var c=0,d;for(d in b.players)c++;1===c&&a.getReady();c=0;for(d in b.players){var e=
b.players[d];c++;if("undefined"==typeof players[e]){var h=playerColorsShuffled.splice(0,1)[0];players[e]=new Player(e,canvas.width,canvas.height,h,c);socket.emit("update-player-color",{viewerId:viewerId,gameRoom:gameRoom,playerId:e,playerColor:h})}}for(var f in players){c=!1;for(d in b.players)b.players[d]==f&&(c=!0);c||delete players[f]}});socket.on("player-update",function(a){if("undefined"==typeof players[a.pid])return!1;players[a.pid].props.vector=a.v});(function c(d){requestAnimationFrame(c);
a&&a.tick(d)})()});function log(a){}function logGAEvent(a,b,c){"undefined"!==typeof _gaq&&("undefined"!==typeof b&&"undefined"!==typeof c?(console.log("Viewer, "+a+", "+b+", "+c),_gaq.push(["_trackEvent","Viewer",a,b,c])):_gaq.push(["_trackEvent","Viewer",a]))}function shuffleArray(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}
(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var h=(new Date).getTime(),f=Math.max(0,16-(h-a)),k=window.setTimeout(function(){b(h+f)},f);a=h+f;return k});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();
