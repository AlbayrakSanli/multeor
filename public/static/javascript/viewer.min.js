var Destroyable=function(a,b,c,d,e,f,g){this.props={sprite:a,image:b,x:c,y:d,z:e,frameWidth:a.destroyable||a.animate?b.width/8:b.width,frameHeight:a.destroyable?b.height/2:b.height,destroyedColorIndex:f,currentSpriteFrame:g}};
Destroyable.prototype.draw=function(a,b){if(this.props.x<-1*this.props.frameWidth||this.props.x>a.canvas.width)return!1;this.props.destroyedColorIndex?a.drawImage(this.props.image,this.props.frameWidth*(this.props.destroyedColorIndex-1),this.props.frameHeight,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):this.props.sprite.animate?a.drawImage(this.props.image,this.props.frameWidth*(this.props.currentSpriteFrame-1),0,this.props.frameWidth,
this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):a.drawImage(this.props.image,0,0,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight)};
Destroyable.prototype.collides=function(a,b){if(!this.props.sprite.destroyable||this.props.destroyedColorIndex||this.props.x<-1*this.props.frameWidth||this.props.x>canvas.width)return!1;var c=Math.floor(this.props.x),d=Math.floor(this.props.x+this.props.frameWidth),e=Math.floor(this.props.y),f=Math.floor(this.props.y+this.props.frameHeight),g=Math.floor(this.props.z-20),h=Math.floor(this.props.z+20),k;for(k in a){var m=Math.floor(0.3*a[k].props.z),l=Math.floor(0.3*a[k].props.z),n=Math.floor(a[k].props.x+
l+100),l=Math.floor(a[k].props.x-l+100),p=Math.floor(a[k].props.y+m),m=Math.floor(a[k].props.y-m),r=Math.floor(a[k].props.z);if(r>=g&&r<=h&&n>=c&&l<=d&&p>=e&&m<=f)return k}return!1};var Explosion=function(a,b,c,d,e){for(var f=[],g=0;360>g;g+=Math.round(45)){var h=new ExplosionParticle;h.x=a;h.y=b;h.zIndex=c++;h.scale=d;h.radius=randomFloat(15,25);h.color="rgba("+e+", .5)";h.scaleSpeed=randomFloat(2,4)*d;var k=randomFloat(60,150);h.velocityX=k*Math.cos(g*Math.PI/180);h.velocityY=k*Math.sin(g*Math.PI/180);f.push(h)}return f};
function ExplosionParticle(){this.scale=1;this.y=this.x=0;this.radius=20;this.color="rgba(255,255,255,.5)";this.velocityY=this.velocityX=0;this.scaleSpeed=0.5;this.zIndex=0;this.update=function(a){this.scale-=this.scaleSpeed*a/1E3;0>this.scale&&(this.scale=0);this.x+=this.velocityX*a/1E3;this.y+=this.velocityY*a/1E3};this.draw=function(a,b,c){0>=this.scale||(this.update(20),a.save(),a.translate(this.x,this.y),a.scale(this.scale,this.scale),a.beginPath(),a.arc(0,0,this.radius,0,2*Math.PI,!0),a.closePath(),
a.fillStyle=this.color,a.fill(),a.restore())}};var Game=function(a,b){var c=this;c.props={state:"LOADING",message:!1,levelPath:a,preloadImages:[],images:{},audio:{},world:!1,worldX:0,worldSpeed:10,destroyed:{},explosions:[],spriteAnimationFrame:1};$.ajaxSetup({cache:!0});$.getJSON(c.props.levelPath+"/level.json",function(a){c.props.world=a;for(var b=0;b<a.length;b++)if("undefined"!==typeof a[b].background&&-1===$.inArray(a[b].background,c.props.preloadImages)&&c.props.preloadImages.push(a[b].background),a[b].sprites.length)for(var f=0;f<a[b].sprites.length;f++){var g=
a[b].sprites[f];a[b].sprites[f].origLeft=g.left;"undefined"!=typeof g.path&&-1===$.inArray(g.path,c.props.preloadImages)&&c.props.preloadImages.push(g.path);"undefined"!=typeof g.audio&&"undefined"==typeof c.props.audio[g.audio]&&"none"!=g.audio&&(c.props.audio[g.audio]=null)}Upon.log("Preloading: "+c.props.preloadImages);for(a=0;a<c.props.preloadImages.length;a++)c.loadImage(c.props.preloadImages[a]);c.loadAudio()}).fail(function(a,c,b){throw b;})};
Game.prototype.loadAudio=function(){var a=new Howl({urls:[this.props.levelPath+"/audio/level.mp3",this.props.levelPath+"/audio/level.ogg"],loop:!0});$(window).off("game-audio-start").on("game-audio-start",function(b){a.volume(0.5);a.play()});$(window).off("game-audio-stop").on("game-audio-stop",function(b){$({volume:1}).animate({volume:0},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)},complete:function(){a.stop()}})});for(var b in this.props.audio)this.props.audio[b]=new Howl({urls:[this.props.levelPath+
"/audio/sprites/"+b+".mp3",this.props.levelPath+"/audio/sprites/"+b+".ogg"]});$(".audio-toggle").off("click").on("click",function(a){a.preventDefault();$(this).toggleClass("is-muted");$(this).hasClass("is-muted")?Howler.mute():Howler.unmute()})};
Game.prototype.tick=function(a,b){if("LOADING"==this.props.state)return!1;if("STARTED"==this.props.state||"LEADERBOARD"==this.props.state)this.props.worldX<1E3*this.props.world.length-a.canvas.width?this.props.worldX+=this.props.worldSpeed:this.endGame();var c=Math.ceil(a.canvas.width/1E3),d=Math.floor(this.props.worldX/1E3),e=Math.floor(this.props.worldX%1E3);this.renderBackgrounds(a,c,d,e);this.renderEntities(a,c,d,e);"STARTED"==this.props.state&&this.props.worldX>1E3*this.props.world.length-7E3&&
(this.props.state="LEADERBOARD",this.prepareLeaderboard());("ENDED"==this.props.state||"LEADERBOARD"==this.props.state)&&this.renderLeaderboard(a)};Game.prototype.renderBackgrounds=function(a,b,c,d){for(var e=0;e<=b;e++){var f=this.props.world[c+e];if("undefined"!=typeof f){var g=1E3*e-d;if(!(g>a.canvas.width)){var h=0,k=1E3;g+1E3>a.canvas.width&&(k=a.canvas.width-g);0>g&&(g=0,h=d,k=1E3-d);(f=this.getImage(f.background))&&a.drawImage(f,h,0,k,a.canvas.height,g,0,k,a.canvas.height)}}}};
Game.prototype.renderEntities=function(a,b,c,d){var e=[],f=0;this.props.spriteAnimationFrame=8.9>this.props.spriteAnimationFrame?this.props.spriteAnimationFrame+0.1:1;for(var g=Math.floor(this.props.spriteAnimationFrame),h=0;h<=b;h++){var k=this.props.world[c+h];if("undefined"!=typeof k)for(var m in k.sprites){var l=k.sprites[m],n=this.props.destroyed[l.id]||!1,p=1E3*h-d+l.left,r=l.top,s=50*l.layer,q=f+1E3*l.layer,t=this.getImage(l.path);p<-1*t.width||p>canvas.width||(l.left-=1.25*(l.layer-1),e[q]=
new Destroyable(l,t,p,r,s,n,g),l.destroyable&&!n&&(n=e[q].collides(players,d),0<n&&(s=players[n].props.color,q=$.inArray(s,playerColors)+1,this.props.destroyed[l.id]=q,0<l.score&&(players[n].updateScore(l.score),q=f+1E3*l.layer+200,t=5*parseInt(l.layer,10),p=Explosion(p-50,r- -1*(players[n].props.z/2),q,t,s),this.props.explosions=this.props.explosions.concat(p)),l.audio&&"none"!=l.audio&&this.props.audio[l.audio].volume(1).play())),f++)}}for(var u in players)q=1E3*players[u].props.vector[2]+900+players[u].props.playerNumber,
e[q]=players[u];if(this.props.explosions.length)for(var v in this.props.explosions)b=this.props.explosions[v],b.dead||(e[b.zIndex]=b);for(v in e)e[v].draw(a,d)};Game.prototype.renderText=function(a){var b=a.canvas.width/2;this.drawMessage(a,this.props.message,(a.canvas.width-b)/2,a.canvas.height/2.2,b,35,!0)};
Game.prototype.prepareLeaderboard=function(){var a=0,b=1E4,c=[],d;for(d in players)players[d].lockPlayer(),players[d].props.score>a&&(a=players[d].props.score),players[d].props.score<b&&(b=players[d].props.score),c.push([players[d],players[d].props.score]);c.sort(function(a,b){return b[1]-a[1]});logGAEvent("Ended","Highest score",a);var e=0,f;for(f in players)e++;e=(600-60*e)/2;f=canvas.width/2-400;var g=0;for(d in c){g++;var h=c[d][0];h.props.endX=Math.floor(800*((h.props.score-b)/a)+f);h.props.endY=
Math.floor(g*h.props.endZ-h.props.endZ/2+e)}};Game.prototype.renderLeaderboard=function(a){var b=canvas.width/2,c;for(c in players)players[c].props.x<players[c].props.endX+10&&players[c].props.x>players[c].props.endX-10&&players[c].props.y<players[c].props.endY+10&&players[c].props.y>players[c].props.endY-10&&this.drawMessage(a,players[c].props.score,players[c].props.endX+140,players[c].props.endY+9,b,35,!1)};Game.prototype.message=function(a){this.props.message=a};
Game.prototype.loadImage=function(a){if("undefined"==typeof this.props.images[a]){var b=this,c=new Image;c.src=this.props.levelPath+a;c.onload=function(){b.props.images[a]={width:this.width,height:this.height,image:this};var c=0,e;for(e in b.props.images)c++;100<=Math.floor(100/b.props.preloadImages.length*c)&&(b.props.state="WAITING")};c.onerror=function(){throw"image "+a+" not found";}}};
Game.prototype.getImage=function(a){return"undefined"!==typeof this.props.images[a]?this.props.images[a].image:!1};Game.prototype.resetGame=function(){socket.emit("game-reset",{viewerId:viewerId,gameRoom:gameRoom});document.location.reload()};Game.prototype.abortGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ABORTED";$(window).trigger("game-audio-stop");logGAEvent("Aborted");setTimeout(function(){a.resetGame()},2E3)};
Game.prototype.endGame=function(){this.props.state="ENDED";$(window).trigger("game-audio-stop");setTimeout(function(){var a=context.getImageData((canvas.width-1E3)/2,0,1E3,600),b=document.createElement("canvas"),c=b.getContext("2d");b.width=1E3;b.height=600;c.putImageData(a,0,0);c.font="80px nevis";c.fillStyle="#FFFFFF";c.fillText("Multeor",650,550);a=b.toDataURL();socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom,leaderboard:a});$(".leaderboard-container").fadeIn(1E3)},1E3)};
Game.prototype.getReady=function(){var a=this;if("WAITING"!=a.props.state)return!1;$(window).trigger("game-audio-start");a.props.state="GETREADY";socket.emit("game-get-ready",{viewerId:viewerId,gameRoom:gameRoom});setTimeout(function(){a.startGame()},4E3)};
Game.prototype.startGame=function(){if("GETREADY"!=this.props.state)return!1;this.props.state="STARTED";socket.emit("game-start",{viewerId:viewerId,gameRoom:gameRoom});var a=0,b;for(b in players)a++;logGAEvent("Started","Players",a);$({i:0.5}).animate({i:1},{duration:2E3,step:function(a){context.globalAlpha=a}})};
Game.prototype.drawMessage=function(a,b,c,d,e,f,g){a.save();a.font="30px nevis";a.fillStyle="#FFFFFF";b=b.toString().split(" ");for(var h="",k=0;k<b.length;k++){var m=h+b[k]+" ",l=a.measureText(m).width;l>e?(a.fillText(h,c,d),h=b[k]+" ",d+=f):(g&&(c=a.canvas.width/2-l/2),h=m)}a.fillText(h,c,d);a.restore()};var Player=function(a,b,c,d,e){var f=this;f.props={playerId:b,playerNumber:e,icon:!1,score:0,x:0,y:0,z:0,vector:[0,0,0],minX:60,maxX:a.canvas.width-180,minY:0,maxY:a.canvas.height,minZ:50,maxZ:150,color:d,lastMoves:[],meteorHeadAngle:45*e,locked:!1,endX:0,endY:0,endZ:60};f.props.y=e*(f.props.minZ+18);c?(a=new Image,a.crossOrigin="Anonymous",a.src=c,a.onload=function(){f.loadIcon(this)}):f.loadIcon()};
Player.prototype.draw=function(a){this.updatePosition();if(9<this.props.lastMoves.length){var b=this.props.lastMoves[0][1],c=this.props.lastMoves[6][0],d=this.props.lastMoves[6][1],e=this.props.lastMoves[7][0],f=this.props.lastMoves[7][1],g=100+this.props.lastMoves[9][0],h=this.props.lastMoves[9][1];a.lineWidth=this.props.z;var k=a.createLinearGradient(0,0,g-a.lineWidth/2,0);k.addColorStop(1,"rgba("+this.props.color+",1)");k.addColorStop(0,"rgba("+this.props.color+",0)");a.strokeStyle=k;a.lineCap=
"round";a.beginPath();a.moveTo(0,b);a.bezierCurveTo(c,d,e,f,g,h);a.stroke();this.props.icon&&(a.save(),a.translate(g,h),a.rotate(Math.PI/180*this.props.meteorHeadAngle),this.props.meteorHeadAngle++,b=Math.floor(0.6*this.props.z),c=Math.floor(0.6*this.props.z),a.drawImage(this.props.icon,Math.floor(-1*(b/2)),Math.floor(-1*(c/2)),b,c),a.restore())}};
Player.prototype.updatePosition=function(){if(this.props.locked)this.props.x<this.props.endX&&(this.props.x+=2),this.props.y<this.props.endY&&(this.props.y+=2),this.props.z<this.props.endZ&&(this.props.z+=1),this.props.x>this.props.endX&&(this.props.x-=2),this.props.y>this.props.endY&&(this.props.y-=2),this.props.z>this.props.endZ&&(this.props.z-=1);else{var a=0.1,b=this.props.vector[0]*(Math.PI/180);this.props.z-3>50*this.props.vector[2]?this.props.z-=3:this.props.z+3<50*this.props.vector[2]&&(this.props.z+=
3);this.props.z>this.props.maxZ&&(this.props.z=this.props.maxZ);this.props.z<this.props.minZ&&(this.props.z=this.props.minZ);90<this.props.vector[0]&&270>this.props.vector[0]&&(a*=2);this.props.x+=Math.cos(b)*this.props.vector[1]*a;this.props.x>this.props.maxX&&(this.props.x=this.props.maxX);this.props.x<this.props.minX&&(this.props.x=this.props.minX);a=this.props.z/2;this.props.y+=0.1*Math.sin(b)*this.props.vector[1];this.props.y>this.props.maxY-a&&(this.props.y=this.props.maxY-a);this.props.y<this.props.minY+
a&&(this.props.y=this.props.minY+a)}this.props.lastMoves.push([this.props.x,this.props.y]);10<this.props.lastMoves.length&&this.props.lastMoves.shift()};Player.prototype.updateScore=function(a){this.props.score+=a;socket.emit("update-score",{viewerId:viewerId,gameRoom:gameRoom,playerId:this.props.playerId,score:this.props.score})};Player.prototype.lockPlayer=function(){this.props.locked=!0};
Player.prototype.loadIcon=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=100;b.height=100;var d=b.width/2;a?c.drawImage(a,0,0,b.width,b.height):(c.fillStyle="rgba(0,0,0,1)",c.fillRect(0,0,b.width,b.height));c.globalCompositeOperation="destination-in";this.drawPolygon(c,d,d,d,8);this.props.icon=b};
Player.prototype.drawPolygon=function(a,b,c,d,e){var f=360/e*(Math.PI/180),g,h;a.beginPath();a.moveTo(Math.cos(m)*d,Math.cos(m)*d);for(var k=0;k<e;k++){var m=k*f,l=b+Math.cos(m)*d,m=c+Math.sin(m)*d;0<k?a.lineTo(l,m):(g=l,h=m);k==e-1&&a.lineTo(g,h)}a.closePath();a.fill()};profiler={context:!1,speedLog:[],frameCount:0,frameStartTime:0,fpsLog:[],paintCountLog:[],lastPaintCount:0,target:15,x:0,y:0,graphScale:0.25,start:function(a,b,c,d,e){window.mozPaintCount&&(profiler.lastPaintCount=window.mozPaintCount);profiler.context=a;profiler.x=c;profiler.y=d;profiler.graphScale=e;profiler.target=b;setTimeout(profiler.getStats,1E3)},tick:function(){var a=(new Date).getTime();profiler.frameStartTime&&profiler.speedLog.push(a-profiler.frameStartTime);profiler.frameStartTime=a;profiler.frameCount++;
profiler.drawStats()},getStats:function(){window.mozPaintCount&&(profiler.paintCountLog.push(window.mozPaintCount-profiler.lastPaintCount),profiler.lastPaintCount=window.mozPaintCount);profiler.fpsLog.push(profiler.frameCount);profiler.frameCount=0},drawStats:function(a){var b=profiler.x,c=profiler.y;profiler.context.save();profiler.context.font="normal 10px monospace";profiler.context.textAlign="left";profiler.context.textBaseLine="top";profiler.context.fillStyle="black";profiler.context.fillRect(b,
c-10,120,85);c+=30;b+=10;profiler.context.beginPath();profiler.context.strokeStyle="#888";profiler.context.lineWidth=1.5;profiler.context.moveTo(b,c);profiler.context.lineTo(b+100,c);profiler.context.stroke();profiler.context.moveTo(b,c);profiler.context.lineTo(b,c-25);profiler.context.stroke();profiler.context.strokeStyle="#00ffff";profiler.context.fillStyle="#00ffff";profiler.context.lineWidth=0.3;var d=profiler.speedLog.length,e=50<profiler.speedLog.length?profiler.speedLog.length-50:0;profiler.context.beginPath();
for(var f=0;e<d;e++,f+=2)profiler.context.moveTo(b+f,c),profiler.context.lineTo(b+f,c-profiler.speedLog[e]*profiler.graphScale),profiler.context.stroke();profiler.context.beginPath();profiler.context.strokeStyle="#FF0000";profiler.context.lineWidth=1;d=c-profiler.target*profiler.graphScale;profiler.context.moveTo(b,d);profiler.context.lineTo(b+100,d);profiler.context.stroke();c+=12;if(a){d=0;for(e in profiler.speedLog)d+=profiler.speedLog[e];d=Math.floor(10*(d/profiler.speedLog.length))/10}else d=
profiler.speedLog[profiler.speedLog.length-1];profiler.context.fillText("Render Time: "+d,b,c);profiler.context.fillStyle="#00ff00";c+=12;if(a){fps=0;for(e in profiler.fpsLog)fps+=profiler.fpsLog[e];fps=Math.floor(10*(fps/profiler.fpsLog.length))/10}else fps=profiler.fpsLog[profiler.fpsLog.length-1];profiler.context.fillText(" Canvas FPS: "+fps,b,c);if(window.mozPaintCount){if(a){fps=0;for(e in profiler.paintCountLog)fps+=profiler.paintCountLog[e];fps=Math.floor(10*(fps/profiler.paintCountLog.length))/
10}else fps=profiler.paintCountLog[profiler.paintCountLog.length-1];profiler.context.fillText("Browser FPS: "+fps,b,c+12)}profiler.context.restore()}};var canvas=document.getElementById("canvas"),context=canvas.getContext("2d");canvas.width=window.innerWidth;canvas.height=600;context.globalAlpha=0.5;var socket=io.connect(window.location.hostname+":843"),players={},game=!1,playerColors="110,8,157 0,255,247 16,230,34 255,174,26 255,255,0 255,110,221 8,103,255 255,0,36".split(" "),playerColorsShuffled=shuffleArray(playerColors.slice(0)),gameRoom=sessionStorage.getItem("game-room")||Math.floor(1E4*Math.random()+1E4);
sessionStorage.setItem("game-room",gameRoom);var viewerId=sessionStorage.getItem("viewer-id")||Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("viewer-id",viewerId);
$(document).ready(function(){var a=new Game("/levels/forest",gameRoom);socket.emit("new-viewer",{viewerId:viewerId,gameRoom:gameRoom});socket.on("game-end",function(b){a.abortGame()});socket.on("game-invalid",function(a){sessionStorage.setItem("viewer-id","");sessionStorage.setItem("game-room","");alert("Sorry, no game hijacking");document.location="/";logGAEvent("Game hijacking?")});socket.on("update-game-state",function(a){var b=0,c;for(c in a.players)b++;b&&$("#gameStart").removeClass("disabled");
b=0;for(c in a.players){var d=a.players[c].playerId;b++;if("undefined"==typeof players[d]){var e=playerColorsShuffled.splice(0,1)[0];players[d]=new Player(context,d,a.players[c].playerIcon,e,b);socket.emit("update-player-color",{viewerId:viewerId,gameRoom:gameRoom,playerId:d,playerColor:e})}}for(var l in players){b=!1;for(c in a.players)a.players[c].playerId==l&&(b=!0);b||delete players[l]}});socket.on("player-update",function(a){if("undefined"==typeof players[a.pid])return!1;players[a.pid].props.vector=
a.v});var b,c,d=(new Date).getTime(),e=1E3/60;(function g(h){requestAnimationFrame(g);b=(new Date).getTime();c=b-d;c>e&&(d=b-c%e,a&&a.tick(context,c))})();$(".gamecode-container").html(gameRoom);$("#gameStart").off("click").on("click",function(b){b.preventDefault();if($(this).hasClass("disabled"))return!1;hideInstructions();a.getReady()});$("#gameReset button").off("click").on("click",function(b){b.preventDefault();a.resetGame()})});
function hideInstructions(){$.each($(".step"),function(a,b){$(b).delay(200*a).animate({top:"+=346"},function(){if(a==$(".step").length-1)for(var b=200,d=$(".step-header").length-1;0<=d;d--)$(".step-header").eq(d).delay(b).animate({opacity:0}),b+=750})});setTimeout(function(){$(".instructions-container").hide()},4E3)}
function showInstructions(){$(".leaderboard-container").hide();$(".instructions-container").show();$(".step").css({top:0,opacity:0}).animate({opacity:1},300);$(".step-header").animate({opacity:1},300)}function shuffleArray(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function randomFloat(a,b){return a+Math.random()*(b-a)}
function logGAEvent(a,b,c){"undefined"!==typeof _gaq&&("undefined"!==typeof b&&"undefined"!==typeof c?(Upon.log("Viewer, "+a+", "+b+", "+c),_gaq.push(["_trackEvent","Viewer",a,b,c])):_gaq.push(["_trackEvent","Viewer",a]))};
