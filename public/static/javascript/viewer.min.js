var Destroyable=function(a,b,c,d,f,h,k,g,e){this.props={id:a,image:b,x:c,y:d,z:f,frameWidth:h||g?b.width/8:b.width,frameHeight:h?b.height/2:b.height,animate:g,destroyable:h,destroyedColorIndex:k,currentSpriteFrame:e}};
Destroyable.prototype.draw=function(a,b){if(this.props.x<-1*this.props.frameWidth||this.props.x>canvas.width)return!1;this.props.destroyedColorIndex?a.drawImage(this.props.image,this.props.frameWidth*(this.props.destroyedColorIndex-1),this.props.frameHeight,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):this.props.animate?a.drawImage(this.props.image,this.props.frameWidth*(this.props.currentSpriteFrame-1),0,this.props.frameWidth,
this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):a.drawImage(this.props.image,0,0,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight)};
Destroyable.prototype.collides=function(a,b){if(!this.props.destroyable||this.props.destroyedColorIndex||this.props.x<-1*this.props.frameWidth||this.props.x>canvas.width)return!1;var c=this.props.x,d=c+this.props.frameWidth,f=this.props.y,h=f+this.props.frameHeight,k=this.props.z-20,g=this.props.z+20;for(player in a){var e=0.2*a[player].props.z,l=0.2*a[player].props.z,n=a[player].props.x+l+100,l=a[player].props.x-l+100,q=a[player].props.y+e,e=a[player].props.y-e,p=a[player].props.z;if(p>=k&&p<=g&&
l>=c&&n<=d&&q>=f&&e<=h)return player}return!1};var Explosion=function(a,b,c,d,f,h){f=[];for(var k=0;360>k;k+=Math.round(36)){var g=new ExplosionParticle;g.x=a;g.y=b;g.zIndex=c++;g.scale=d;g.radius=randomFloat(10,25);g.color="rgba("+h+", .8)";g.scaleSpeed=randomFloat(1,3)*d;var e=randomFloat(60,150);g.velocityX=e*Math.cos(k*Math.PI/180);g.velocityY=e*Math.sin(k*Math.PI/180);f.push(g)}return f};
function ExplosionParticle(){this.scale=1;this.y=this.x=0;this.radius=20;this.color="#000";this.velocityY=this.velocityX=0;this.scaleSpeed=0.5;this.dead=!1;this.zIndex=0;this.update=function(a){0>=this.scale||(this.scale-=this.scaleSpeed*a/1E3,0>=this.scale&&(this.scale=0,this.dead=!0),this.x+=this.velocityX*a/1E3,this.y+=this.velocityY*a/1E3)};this.draw=function(a,b,c){0>=this.scale||(this.update(20),a.save(),a.translate(this.x,this.y),a.scale(this.scale,this.scale),a.beginPath(),a.arc(0,0,this.radius,
0,2*Math.PI,!0),a.closePath(),a.fillStyle=this.color,a.fill(),a.restore())}};var Game=function(a,b){var c=this;c.props={state:"LOADING",message:!1,defaultText:"Go to http://game.multeor.com on your mobile and enter code "+b+" to join",levelPath:a,preloadImages:[],images:{},audio:{},world:!1,worldX:0,worldSpeed:10,destroyed:{},explosions:[],spriteAnimationFrame:1};$.ajaxSetup({cache:!0});$.getJSON(c.props.levelPath+"/level.json",function(a){c.props.world=a;for(var b=0;b<a.length;b++)if("undefined"!=typeof a[b].background&&c.props.preloadImages.push(a[b].background),a[b].sprites.length)for(var h=
0;h<a[b].sprites.length;h++){var k=a[b].sprites[h];"undefined"!=typeof k.path&&-1===$.inArray(k.path,c.props.preloadImages)&&c.props.preloadImages.push(k.path);"undefined"!=typeof k.audio&&"undefined"==typeof c.props.audio[k.audio]&&"none"!=k.audio&&(c.props.audio[k.audio]=null)}Upon.log("Preloading: "+c.props.preloadImages);for(a=0;a<c.props.preloadImages.length;a++)c.loadImage(c.props.preloadImages[a]);c.loadAudio()}).fail(function(a,b,c){throw c;})};
Game.prototype.loadAudio=function(){var a=new Howl({urls:[this.props.levelPath+"/audio/level.mp3",this.props.levelPath+"/audio/level.ogg"],loop:!0});$(window).off("game-audio-start").on("game-audio-start",function(b){b={volume:0};a.volume(b.volume);a.play();$(b).animate({volume:1},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)}})});$(window).off("game-audio-stop").on("game-audio-stop",function(b){$({volume:1}).animate({volume:0},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)},
complete:function(){a.stop()}})});for(var b in this.props.audio)this.props.audio[b]=new Howl({urls:[this.props.levelPath+"/audio/sprites/"+b+".mp3",this.props.levelPath+"/audio/sprites/"+b+".ogg"]})};
Game.prototype.tick=function(a){if("LOADING"==this.props.state)return context.clearRect(0,0,canvas.width,canvas.height),this.props.message.length&&this.renderText(),!1;if("STARTED"==this.props.state||"LEADERBOARD"==this.props.state)this.props.worldX<1E3*this.props.world.length-canvas.width?this.props.worldX+=this.props.worldSpeed:this.endGame();a=Math.ceil(canvas.width/1E3);var b=Math.floor(this.props.worldX/1E3),c=Math.floor(this.props.worldX%1E3);this.renderBackgrounds(a,b,c);this.renderEntities(a,
b,c);this.props.message.length&&this.renderText();"STARTED"==this.props.state&&this.props.worldX>1E3*this.props.world.length-7E3&&(this.props.state="LEADERBOARD",this.renderToLeaderboard());("ENDED"==this.props.state||"LEADERBOARD"==this.props.state)&&this.renderLeaderboard()};
Game.prototype.renderBackgrounds=function(a,b,c){for(var d=0;d<=a;d++){var f=this.props.world[b+d];if("undefined"!=typeof f){var h=1E3*d-c;if(!(h>canvas.width)){var k=0,g=1E3;h+1E3>canvas.width&&(g=canvas.width-h);0>h&&(h=0,k=c,g=1E3-c);(f=this.getImage(f.background))&&context.drawImage(f,k,0,g,canvas.height,h,0,g,canvas.height)}}}};
Game.prototype.renderEntities=function(a,b,c){var d=[],f=0;this.props.spriteAnimationFrame=8.9>this.props.spriteAnimationFrame?this.props.spriteAnimationFrame+0.1:1;for(var h=Math.floor(this.props.spriteAnimationFrame),k=0;k<=a;k++){var g=this.props.world[b+k];if("undefined"!=typeof g)for(sprite in g.sprites){var e=g.sprites[sprite],l=this.props.destroyed[e.id]||!1,n=1E3*k-c+e.left,q=e.top,p=50*e.layer,m=f+1E3*e.layer;e.left-=2*(e.layer-1);d[m]=new Destroyable(e.id,this.getImage(e.path),n,q,p,e.destroyable,
l,e.animate,h);e.destroyable&&!l&&(m=d[m].collides(players,c),!1!==m&&(l=players[m].props.color,p=$.inArray(l,playerColors)+1,this.props.destroyed[e.id]=p,0<e.score&&(players[m].updateScore(e.score),e.audio&&"none"!=e.audio&&this.props.audio[e.audio].volume(0.2).play()),m=f+1E3*e.layer+200,e=Explosion(n,q,m,e.layer,e.score,l),this.props.explosions=this.props.explosions.concat(e)));f++}}for(player in players)m=1E3*players[player].props.vector[2]+900+players[player].props.playerNumber,d[m]=players[player];
if(this.props.explosions.length)for(i in this.props.explosions)a=this.props.explosions[i],a.dead||(d[a.zIndex]=a);for(key in d)d[key].draw(context,c)};Game.prototype.renderText=function(){var a=canvas.width/2;this.drawMessage(context,this.props.message,(canvas.width-a)/2,canvas.height/2.2,a,35,!0)};
Game.prototype.renderToLeaderboard=function(){var a=0,b=[];for(player in players)players[player].lockPlayer(),players[player].props.score>a&&(a=players[player].props.score),b.push([players[player],players[player].props.score]);b.sort(function(a,b){return b[1]-a[1]});logGAEvent("Ended","Highest score",a);var c=0,d=canvas.width/4;for(player in b){var f=b[player][0];c++;f.props.endX=Math.floor(f.props.score/a*(canvas.width/2+d));f.props.endX<canvas.width/2-d&&(f.props.endX=canvas.width/2-d);f.props.endY=
Math.floor(c*(f.props.minZ+30)+70)}};
Game.prototype.renderLeaderboard=function(){var a=canvas.width/2;this.drawMessage(context,"SCORES",(canvas.width-a)/2,70,a,35,!0);for(player in players)players[player].props.x<players[player].props.endX+10&&players[player].props.x>players[player].props.endX-10&&players[player].props.y<players[player].props.endY+10&&players[player].props.y>players[player].props.endY-10&&this.drawMessage(context,players[player].props.score,players[player].props.endX+130,players[player].props.endY+9,a,35,!1)};
Game.prototype.message=function(a){this.props.message=a};Game.prototype.loadImage=function(a){if("undefined"==typeof this.props.images[a]){var b=this,c=new Image;c.src=this.props.levelPath+a;c.onload=function(){b.props.images[a]={width:this.width,height:this.height,image:this};var c=0,f;for(f in b.props.images)c++;c*=100/b.props.preloadImages.length;100<=c?(b.props.state="WAITING",b.message(b.props.defaultText)):b.message(c+"%")};c.onerror=function(){throw"image "+a+" not found";}}};
Game.prototype.getImage=function(a){return"undefined"!==typeof this.props.images[a]?this.props.images[a].image:!1};Game.prototype.resetGame=function(){this.props.worldX=0;this.props.state="WAITING";this.message(this.props.defaultText);this.props.destroyed=[];players={};socket.emit("game-reset",{viewerId:viewerId,gameRoom:gameRoom});clearInterval(getReadyInterval)};
Game.prototype.abortGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ABORTED";$(window).trigger("game-audio-stop");a.message("Game aborted!");logGAEvent("Aborted");setTimeout(function(){a.resetGame()},2E3)};Game.prototype.endGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ENDED";$(window).trigger("game-audio-stop");setTimeout(function(){a.resetGame()},1E4)};
Game.prototype.getReady=function(){var a=this;if("WAITING"!=a.props.state)return!1;$(window).trigger("game-audio-start");a.props.state="GETREADY";socket.emit("game-get-ready",{viewerId:viewerId,gameRoom:gameRoom});var b=4,c=setInterval(function(){if("GETREADY"!=a.props.state)return clearInterval(c),!1;1>b?(a.message("GO!"),clearInterval(c),setTimeout(function(){a.message("");a.startGame()},1E3)):(a.message("Game starting in "+b+" seconds, get ready..."),b--)},1E3)};
Game.prototype.startGame=function(){if("GETREADY"!=this.props.state)return!1;this.props.state="STARTED";socket.emit("game-start",{viewerId:viewerId,gameRoom:gameRoom});var a=0,b;for(b in players)a++;logGAEvent("Started","Players",a)};
Game.prototype.drawMessage=function(a,b,c,d,f,h,k){a.save();a.font="30px ablas_altbold";a.fillStyle="#FFFFFF";b=b.toString().split(" ");for(var g="",e=0;e<b.length;e++){var l=g+b[e]+" ",n=a.measureText(l).width;n>f?(a.fillText(g,c,d),g=b[e]+" ",d+=h):(k&&(c=canvas.width/2-n/2),g=l)}a.fillText(g,c,d);a.restore()};var Player=function(a,b,c,d,f){this.props={playerId:a,playerNumber:f,score:0,x:0,y:0,z:0,vector:[0,0,0],minX:60,maxX:b-180,minY:0,maxY:c,minZ:50,maxZ:150,color:d,lastMoves:[],meteorHeadAngle:0,locked:!1,endX:0,endY:0,endZ:60};this.props.y=f*(this.props.minZ+18)};
Player.prototype.draw=function(a){this.updatePosition();if(9<this.props.lastMoves.length){var b=this.props.lastMoves[0][1],c=this.props.lastMoves[6][0],d=this.props.lastMoves[6][1],f=this.props.lastMoves[7][0],h=this.props.lastMoves[7][1],k=100+this.props.lastMoves[9][0],g=this.props.lastMoves[9][1];a.lineWidth=this.props.z;var e=a.createLinearGradient(0,0,k-a.lineWidth/2,0);e.addColorStop(1,"rgba("+this.props.color+",.8)");e.addColorStop(0,"rgba("+this.props.color+",0)");a.strokeStyle=e;a.lineCap=
"round";a.beginPath();a.moveTo(0,b);a.bezierCurveTo(c,d,f,h,k,g);a.stroke();b=0.2*this.props.z;c=0.2*this.props.z;d=this.props.x-c;f=this.props.x+c;h=this.props.y+b;e=this.props.y-b;a.save();a.fillStyle="rgba(0,0,0,.6)";a.translate(k,g);this.props.meteorHeadAngle++;a.rotate(Math.PI/180*this.props.meteorHeadAngle);a.fillRect(c,b,d-f,e-h);a.restore()}};
Player.prototype.updatePosition=function(){if(this.props.locked)this.props.x+2<this.props.endX&&(this.props.x+=2),this.props.y+2<this.props.endY&&(this.props.y+=2),this.props.z+0.5<this.props.endZ&&(this.props.z+=0.5),this.props.x-2>this.props.endX&&(this.props.x-=2),this.props.y-2>this.props.endY&&(this.props.y-=2),this.props.z-0.5>this.props.endZ&&(this.props.z-=0.5);else{var a=ySpeed=0.1,b=this.props.vector[0]*(Math.PI/180);this.props.z-3>50*this.props.vector[2]?this.props.z-=3:this.props.z+3<
50*this.props.vector[2]&&(this.props.z+=3);this.props.z>this.props.maxZ&&(this.props.z=this.props.maxZ);this.props.z<this.props.minZ&&(this.props.z=this.props.minZ);90<this.props.vector[0]&&270>this.props.vector[0]&&(a*=2);this.props.x+=Math.cos(b)*this.props.vector[1]*a;this.props.x>this.props.maxX&&(this.props.x=this.props.maxX);this.props.x<this.props.minX&&(this.props.x=this.props.minX);a=this.props.z/2;this.props.y+=Math.sin(b)*this.props.vector[1]*ySpeed;this.props.y>this.props.maxY-a&&(this.props.y=
this.props.maxY-a);this.props.y<this.props.minY+a&&(this.props.y=this.props.minY+a)}this.props.lastMoves.push([this.props.x,this.props.y]);10<this.props.lastMoves.length&&this.props.lastMoves.shift()};Player.prototype.updateScore=function(a){this.props.score+=a;socket.emit("update-score",{viewerId:viewerId,gameRoom:gameRoom,playerId:this.props.playerId,score:this.props.score})};Player.prototype.lockPlayer=function(){this.props.locked=!0};profiler={context:!1,speedLog:[],frameCount:0,frameStartTime:0,fpsLog:[],paintCountLog:[],lastPaintCount:0,target:15,x:0,y:0,graphScale:0.25,start:function(a,b,c,d,f){window.mozPaintCount&&(profiler.lastPaintCount=window.mozPaintCount);profiler.context=a;profiler.x=c;profiler.y=d;profiler.graphScale=f;profiler.target=b;setTimeout(profiler.getStats,1E3)},tick:function(){var a=(new Date).getTime();profiler.frameStartTime&&profiler.speedLog.push(a-profiler.frameStartTime);profiler.frameStartTime=a;profiler.frameCount++;
profiler.drawStats()},getStats:function(){window.mozPaintCount&&(profiler.paintCountLog.push(window.mozPaintCount-profiler.lastPaintCount),profiler.lastPaintCount=window.mozPaintCount);profiler.fpsLog.push(profiler.frameCount);profiler.frameCount=0},drawStats:function(a){var b=profiler.x,c=profiler.y;profiler.context.save();profiler.context.font="normal 10px monospace";profiler.context.textAlign="left";profiler.context.textBaseLine="top";profiler.context.fillStyle="black";profiler.context.fillRect(b,
c-10,120,85);c+=30;b+=10;profiler.context.beginPath();profiler.context.strokeStyle="#888";profiler.context.lineWidth=1.5;profiler.context.moveTo(b,c);profiler.context.lineTo(b+100,c);profiler.context.stroke();profiler.context.moveTo(b,c);profiler.context.lineTo(b,c-25);profiler.context.stroke();profiler.context.strokeStyle="#00ffff";profiler.context.fillStyle="#00ffff";profiler.context.lineWidth=0.3;var d=profiler.speedLog.length,f=50<profiler.speedLog.length?profiler.speedLog.length-50:0;profiler.context.beginPath();
for(var h=0;f<d;f++,h+=2)profiler.context.moveTo(b+h,c),profiler.context.lineTo(b+h,c-profiler.speedLog[f]*profiler.graphScale),profiler.context.stroke();profiler.context.beginPath();profiler.context.strokeStyle="#FF0000";profiler.context.lineWidth=1;d=c-profiler.target*profiler.graphScale;profiler.context.moveTo(b,d);profiler.context.lineTo(b+100,d);profiler.context.stroke();c+=12;if(a){d=0;for(f in profiler.speedLog)d+=profiler.speedLog[f];d=Math.floor(10*(d/profiler.speedLog.length))/10}else d=
profiler.speedLog[profiler.speedLog.length-1];profiler.context.fillText("Render Time: "+d,b,c);profiler.context.fillStyle="#00ff00";c+=12;if(a){fps=0;for(f in profiler.fpsLog)fps+=profiler.fpsLog[f];fps=Math.floor(10*(fps/profiler.fpsLog.length))/10}else fps=profiler.fpsLog[profiler.fpsLog.length-1];profiler.context.fillText(" Canvas FPS: "+fps,b,c);if(window.mozPaintCount){if(a){fps=0;for(f in profiler.paintCountLog)fps+=profiler.paintCountLog[f];fps=Math.floor(10*(fps/profiler.paintCountLog.length))/
10}else fps=profiler.paintCountLog[profiler.paintCountLog.length-1];profiler.context.fillText("Browser FPS: "+fps,b,c+12)}profiler.context.restore()}};var canvas=document.getElementById("canvas"),context=canvas.getContext("2d");canvas.width=window.innerWidth;canvas.height=600;var socket=io.connect(window.location.hostname+":3333"),players={},getReadyInterval=!1,game=!1,playerColors="255,0,36 8,103,255 255,110,221 255,255,0 110,8,157 0,255,247 16,230,34 255,174,26".split(" "),playerColorsShuffled=shuffleArray(playerColors.slice(0)),gameRoom=sessionStorage.getItem("game-room")||Math.floor(1E4*Math.random()+1E4);
sessionStorage.setItem("game-room",gameRoom);var viewerId=sessionStorage.getItem("viewer-id")||Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("viewer-id",viewerId);
$(document).ready(function(){var a=new Game("/levels/forest",gameRoom);socket.emit("new-viewer",{viewerId:viewerId,gameRoom:gameRoom});socket.on("game-end",function(b){a.abortGame()});socket.on("game-invalid",function(a){sessionStorage.setItem("viewer-id","");sessionStorage.setItem("game-room","");alert("Sorry, no game hijacking");document.location="/";logGAEvent("Room hijacking?")});socket.on("update-game-state",function(b){var c=0,d;for(d in b.players)c++;1===c&&a.getReady();c=0;for(d in b.players){var g=
b.players[d];c++;if("undefined"==typeof players[g]){var e=playerColorsShuffled.splice(0,1)[0];players[g]=new Player(g,canvas.width,canvas.height,e,c);socket.emit("update-player-color",{viewerId:viewerId,gameRoom:gameRoom,playerId:g,playerColor:e})}}for(var l in players){c=!1;for(d in b.players)b.players[d]==l&&(c=!0);c||delete players[l]}});socket.on("player-update",function(a){if("undefined"==typeof players[a.pid])return!1;players[a.pid].props.vector=a.v});profiler.start(context,12,245,120,1);var b,
c,d=(new Date).getTime();(function h(k){requestAnimationFrame(h);b=(new Date).getTime();c=b-d;d=b;a&&a.tick(c);profiler.tick()})()});function logGAEvent(a,b,c){"undefined"!==typeof _gaq&&("undefined"!==typeof b&&"undefined"!==typeof c?(Upon.log("Viewer, "+a+", "+b+", "+c),_gaq.push(["_trackEvent","Viewer",a,b,c])):_gaq.push(["_trackEvent","Viewer",a]))}function shuffleArray(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}
(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var h=(new Date).getTime(),k=Math.max(0,16-(h-a)),g=window.setTimeout(function(){b(h+k)},k);a=h+k;return g});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();function randomFloat(a,b){return a+Math.random()*(b-a)};
