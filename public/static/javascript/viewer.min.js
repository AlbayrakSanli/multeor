var Destroyable=function(a,b,c,d,f,k,g){this.props={sprite:a,image:b,x:c,y:d,z:f,frameWidth:a.destroyable||a.animate?b.width/8:b.width,frameHeight:a.destroyable?b.height/2:b.height,destroyedColorIndex:k,currentSpriteFrame:g}};
Destroyable.prototype.draw=function(a){if(this.props.x<-1*this.props.frameWidth||this.props.x>a.canvas.width)return!1;this.props.destroyedColorIndex?a.drawImage(this.props.image,this.props.frameWidth*(this.props.destroyedColorIndex-1),this.props.frameHeight,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):this.props.sprite.animate?a.drawImage(this.props.image,this.props.frameWidth*(this.props.currentSpriteFrame-1),0,this.props.frameWidth,
this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight):a.drawImage(this.props.image,0,0,this.props.frameWidth,this.props.frameHeight,this.props.x,this.props.y,this.props.frameWidth,this.props.frameHeight)};
Destroyable.prototype.collides=function(a,b){if(!this.props.sprite.destroyable||this.props.destroyedColorIndex||this.props.x<-1*this.props.frameWidth||this.props.x>canvas.width)return!1;var c=Math.floor(this.props.x),d=Math.floor(this.props.x+this.props.frameWidth),f=Math.floor(this.props.y),k=Math.floor(this.props.y+this.props.frameHeight),g=Math.floor(this.props.z-20),e=Math.floor(this.props.z+20),h,l,m,r,p,n;for(n in a)if(h=Math.floor(0.3*a[n].props.z),l=Math.floor(0.3*a[n].props.z),m=Math.floor(a[n].props.x+
l+100),l=Math.floor(a[n].props.x-l+100),r=Math.floor(a[n].props.y+h),h=Math.floor(a[n].props.y-h),p=Math.floor(a[n].props.z),p>=g&&p<=e&&m>=c&&l<=d&&r>=f&&h<=k)return n;return!1};var Explosion=function(a,b,c,d,f){for(var k=[],g,e,h=0;360>h;h+=Math.round(45))e=new ExplosionParticle,e.x=a,e.y=b,e.zIndex=c++,e.scale=d,e.radius=randomFloat(15,25),e.color="rgba("+f+", .5)",e.scaleSpeed=randomFloat(2,4)*d,g=randomFloat(60,150),e.velocityX=g*Math.cos(h*Math.PI/180),e.velocityY=g*Math.sin(h*Math.PI/180),k.push(e);return k};
function ExplosionParticle(){this.scale=1;this.y=this.x=0;this.radius=20;this.color="rgba(255,255,255,.5)";this.velocityY=this.velocityX=0;this.scaleSpeed=0.5;this.zIndex=0;this.update=function(a){this.scale-=this.scaleSpeed*a/1E3;0>this.scale&&(this.scale=0);this.x+=this.velocityX*a/1E3;this.y+=this.velocityY*a/1E3};this.draw=function(a){this.update(15);1>this.scale||(a.save(),a.translate(this.x,this.y),a.scale(this.scale,this.scale),a.beginPath(),a.arc(0,0,this.radius,0,2*Math.PI,!0),a.closePath(),
a.fillStyle=this.color,a.fill(),a.restore())}};var Game=function(a,b){var c=this;c.props={state:"LOADING",message:!1,levelPath:a,preloadImages:[],images:{},audio:{},world:!1,worldX:0,worldSpeed:10,numberOfTiles:0,bgBase:0,bgModulus:0,destroyed:{},explosions:[],spriteAnimationFrame:1};$.ajaxSetup({cache:!0});$.getJSON(c.props.levelPath+"/level.json",function(a){c.props.world=a;for(var b=0;b<a.length;b++)if("undefined"!==typeof a[b].background&&-1===$.inArray(a[b].background,c.props.preloadImages)&&c.props.preloadImages.push(a[b].background),a[b].sprites.length)for(var k=
0;k<a[b].sprites.length;k++){var g=a[b].sprites[k];a[b].sprites[k].origLeft=g.left;"undefined"!=typeof g.path&&-1===$.inArray(g.path,c.props.preloadImages)&&c.props.preloadImages.push(g.path);"undefined"!=typeof g.audio&&"undefined"==typeof c.props.audio[g.audio]&&"none"!=g.audio&&(c.props.audio[g.audio]=null)}Upon.log("Preloading: "+c.props.preloadImages);for(a=0;a<c.props.preloadImages.length;a++)c.loadImage(c.props.preloadImages[a]);c.loadAudio()}).fail(function(a,b,c){throw c;});this.updateHighestScore()};
Game.prototype.loadAudio=function(){var a=new Howl({urls:[this.props.levelPath+"/audio/level.mp3",this.props.levelPath+"/audio/level.ogg"],loop:!0});$(window).off("game-audio-start").on("game-audio-start",function(b){a.volume(0.5);a.play()});$(window).off("game-audio-stop").on("game-audio-stop",function(b){$({volume:0.5}).animate({volume:0},{easing:"linear",duration:5E3,step:function(b,c){a.volume(b)},complete:function(){a.stop()}})});for(var b in this.props.audio)this.props.audio[b]=new Howl({urls:[this.props.levelPath+
"/audio/sprites/"+b+".mp3",this.props.levelPath+"/audio/sprites/"+b+".ogg"]});$(".audio-toggle").off("click").on("click",function(a){a.preventDefault();$(this).toggleClass("is-muted");$(this).hasClass("is-muted")?(Howler.mute(),sessionStorage.setItem("audio-muted",!0)):(Howler.unmute(),sessionStorage.removeItem("audio-muted"))});sessionStorage.getItem("audio-muted")&&$(".audio-toggle").trigger("click")};
Game.prototype.tick=function(a,b){if("LOADING"==this.props.state)return!1;if("STARTED"==this.props.state||"LEADERBOARD"==this.props.state)this.props.worldX<1E3*this.props.world.length-a.canvas.width?this.props.worldX+=this.props.worldSpeed:this.endGame();this.props.numberOfTiles=Math.ceil(a.canvas.width/1E3);this.props.bgBase=Math.floor(this.props.worldX/1E3);this.props.bgModulus=Math.floor(this.props.worldX%1E3);this.renderBackgrounds(a,this.props.numberOfTiles,this.props.bgBase,this.props.bgModulus);
this.renderEntities(a,this.props.numberOfTiles,this.props.bgBase,this.props.bgModulus);"STARTED"==this.props.state&&this.props.worldX>1E3*this.props.world.length-8E3&&(this.props.state="LEADERBOARD",this.prepareLeaderboard());("ENDED"==this.props.state||"LEADERBOARD"==this.props.state)&&this.renderLeaderboard(a)};
Game.prototype.renderBackgrounds=function(a,b,c,d){var f,k,g,e,h;for(f=0;f<=b;f++)k=this.props.world[c+f],"undefined"!=typeof k&&(g=1E3*f-d,g>a.canvas.width||(e=0,h=1E3,0>g&&(g=0,e=d,h=1E3-d),(k=this.getImage(k.background))&&a.drawImage(k,e,0,h,a.canvas.height,g,0,h,a.canvas.height)))};
Game.prototype.renderEntities=function(a,b,c,d){this.props.entities={};this.props.entitiesKeys=[];this.props.entitiesOffset=0;this.props.spriteAnimationFrame=this.props.spriteAnimationFrame<9-this.props.spriteAnimationStep?this.props.spriteAnimationFrame+this.props.spriteAnimationStep:1;this.props.currentSpriteFrame=Math.floor(this.props.spriteAnimationFrame);var f,k,g,e,h,l,m,r,p,n,q,s;for(f=-3;f<=b+1;f++)if(k=this.props.world[c+f],"undefined"!=typeof k)for(g in k.sprites)this.props.entitiesOffset++,
e=k.sprites[g],h=this.props.destroyed[e.id]||!1,l=1E3*f-d+e.left,m=e.top,r=50*e.layer,p=this.props.entitiesOffset+1E3*e.layer,n=this.getImage(e.path),l<-1*n.width||l>canvas.width||("STARTED"==this.props.state&&(e.left-=1.25*(e.layer-1)),this.props.entities[p]=new Destroyable(e,n,l,m,r,h,this.props.currentSpriteFrame),this.props.entitiesKeys.push(p),e.destroyable&&!h&&(r=this.props.entities[p].collides(players),0<r&&(h=players[r].props.color,p=$.inArray(h,playerColors)+1,this.props.destroyed[e.id]=
p,e.destroylink&&(this.props.destroyed[e.destroylink]=p),0<e.score&&(players[r].updateScore(e.score),p=this.props.entitiesOffset+1E3*e.layer+200,n=5*parseInt(e.layer,10),m-=-1*(players[r].props.z/2),l=Explosion(l-50,m,p,n,h),this.props.explosions=this.props.explosions.concat(l)),e.audio&&"none"!=e.audio&&this.props.audio[e.audio].volume(1).play())));for(q in players)b=1E3*players[q].props.vector[2]+900+players[q].props.playerNumber,this.props.entities[b]=players[q],this.props.entitiesKeys.push(b),
b=players[q].props.playerNumber+1500,this.props.entities[b]=new PlayerShadow(players[q]),this.props.entitiesKeys.push(b);if(this.props.explosions.length)for(s in this.props.explosions)q=this.props.explosions[s],q.dead||(this.props.entities[q.zIndex]=q,this.props.entitiesKeys.push(q.zIndex));this.props.entitiesKeys.sort();for(f=0;f<this.props.entitiesKeys.length;f++)this.props.entities[this.props.entitiesKeys[f]].draw(a)};
Game.prototype.renderText=function(a){var b=a.canvas.width/2;this.drawMessage(a,this.props.message,(a.canvas.width-b)/2,a.canvas.height/2.2,b,35,!0)};
Game.prototype.prepareLeaderboard=function(){var a=0,b=1E4,c=[],d;for(d in players)players[d].lockPlayer(),players[d].props.score>a&&(a=players[d].props.score),players[d].props.score<b&&(b=players[d].props.score),c.push([players[d],players[d].props.score]);c.sort(function(a,b){return b[1]-a[1]});logGAEvent("Ended","Highest score",a);var f=0,k;for(k in players)f++;f=(600-60*f)/2;k=canvas.width/2-400;var g=0;for(d in c){g++;var e=c[d][0];e.props.endX=Math.floor(800*((e.props.score-b)/a)+k);e.props.endY=
Math.floor(g*e.props.endZ-e.props.endZ/2+f)}socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom})};Game.prototype.renderLeaderboard=function(a){var b=canvas.width/2,c;for(c in players)players[c].props.x<players[c].props.endX+10&&players[c].props.x>players[c].props.endX-10&&players[c].props.y<players[c].props.endY+10&&players[c].props.y>players[c].props.endY-10&&this.drawMessage(a,players[c].props.score,players[c].props.endX+140,players[c].props.endY+9,b,35,!1)};
Game.prototype.message=function(a){this.props.message=a};Game.prototype.loadImage=function(a){if("undefined"==typeof this.props.images[a]){var b=this,c=new Image;c.src=this.props.levelPath+a;c.onload=function(){b.props.images[a]={width:this.width,height:this.height,image:this};var c=0,f;for(f in b.props.images)c++;100<=Math.floor(100/b.props.preloadImages.length*c)&&(b.props.state="WAITING")};c.onerror=function(){throw"image "+a+" not found";}}};
Game.prototype.getImage=function(a){return"undefined"!==typeof this.props.images[a]?this.props.images[a].image:!1};Game.prototype.resetGame=function(){socket.emit("game-reset",{viewerId:viewerId,gameRoom:gameRoom});document.location.reload()};Game.prototype.abortGame=function(){var a=this;socket.emit("game-end",{viewerId:viewerId,gameRoom:gameRoom});a.props.state="ABORTED";$(window).trigger("game-audio-stop");logGAEvent("Aborted");setTimeout(function(){a.resetGame()},2E3)};
Game.prototype.endGame=function(){var a=this;a.props.state="ENDED";$(window).trigger("game-audio-stop");setTimeout(function(){$(".leaderboard-container").fadeIn(1E3);var b=context.getImageData((canvas.width-1E3)/2,0,1E3,600),c=document.createElement("canvas"),d=c.getContext("2d");c.width=1E3;c.height=600;d.putImageData(b,0,0);d.font="80px NevisRegular";d.fillStyle="#FFFFFF";d.fillText("Multeor",650,550);b=c.toDataURL();socket.emit("store-leaderboard",{viewerId:viewerId,gameRoom:gameRoom,leaderboard:b});
a.updateHighestScore()},1E3)};Game.prototype.getReady=function(){var a=this;if("WAITING"!=a.props.state)return!1;$(window).trigger("game-audio-start");a.props.state="GETREADY";socket.emit("game-get-ready",{viewerId:viewerId,gameRoom:gameRoom});setTimeout(function(){a.startGame()},4E3)};
Game.prototype.startGame=function(){if("GETREADY"!=this.props.state)return!1;this.props.state="STARTED";socket.emit("game-start",{viewerId:viewerId,gameRoom:gameRoom});var a=0,b;for(b in players)a++;logGAEvent("Started","Players",a);$({i:0.5}).animate({i:1},{duration:2E3,step:function(a){context.globalAlpha=a}})};
Game.prototype.updateHighestScore=function(){$.ajaxSetup({cache:!1});$.getJSON("/high-score-public.json",function(a){$(".highestScoreEver").empty().html('<p>Highest score ever: <span class="hero-score">'+a.score+'</span></p><div class="buddy-icon"><div class="mask"></div></div><div class="hero-name">'+a.name+"</div>");$(".highestScoreEver .buddy-icon").css({backgroundImage:"url("+a.icon+")"});$(".highestScoreEver").fadeIn(1E3)})};
Game.prototype.drawMessage=function(a,b,c,d,f,k,g){a.save();a.font="30px NevisRegular";a.fillStyle="#FFFFFF";b=b.toString().split(" ");for(var e="",h=0;h<b.length;h++){var l=e+b[h]+" ",m=a.measureText(l).width;m>f?(a.fillText(e,c,d),e=b[h]+" ",d+=k):(g&&(c=a.canvas.width/2-m/2),e=l)}a.fillText(e,c,d);a.restore()};var Player=function(a,b,c,d,f,k){var g=this;g.props={playerId:b,playerNumber:f,webAudioSupported:k,icon:!1,score:0,x:0,y:0,z:0,vector:[0,0,0],minX:60,maxX:a.canvas.width-180,minY:0,maxY:a.canvas.height,minZ:50,maxZ:150,color:d,lastMoves:[],meteorHeadAngle:45*f,locked:!1,endX:0,endY:0,endZ:60};g.props.y=f*(g.props.minZ+18);c?(a=new Image,a.crossOrigin="Anonymous",a.src=c,a.onload=function(){g.loadIcon(this)}):g.loadIcon()};
Player.prototype.draw=function(a){this.updatePosition();if(9<this.props.lastMoves.length){var b=this.props.lastMoves[0][1],c=this.props.lastMoves[6][0],d=this.props.lastMoves[6][1],f=this.props.lastMoves[7][0],k=this.props.lastMoves[7][1],g=100+this.props.lastMoves[9][0],e=this.props.lastMoves[9][1];a.lineWidth=this.props.z;var h=a.createLinearGradient(0,0,g-a.lineWidth/2,0);h.addColorStop(1,"rgba("+this.props.color+",1)");h.addColorStop(0,"rgba("+this.props.color+",0)");a.strokeStyle=h;a.lineCap=
"round";a.beginPath();a.moveTo(0,b);a.bezierCurveTo(c,d,f,k,g,e);a.stroke();this.props.icon&&(a.save(),a.translate(g,e),a.rotate(Math.PI/180*this.props.meteorHeadAngle),this.props.meteorHeadAngle++,b=Math.floor(0.6*this.props.z),c=Math.floor(0.6*this.props.z),a.drawImage(this.props.icon,Math.floor(-1*(b/2)),Math.floor(-1*(c/2)),b,c),a.restore())}};
Player.prototype.shadow=function(a){if(9<this.props.lastMoves.length){var b=-50*(this.props.z-this.props.minZ)/(this.props.maxZ-this.props.minZ),c=this.props.minZ,d=1.5*this.props.z-1.5*c;if(!(5>d)){var f=0+b,k=this.props.lastMoves[0][1]+d,g=this.props.lastMoves[6][0]+b,e=this.props.lastMoves[6][1]+d,h=this.props.lastMoves[7][0]+b,l=this.props.lastMoves[7][1]+d,b=100+this.props.lastMoves[9][0]+b,d=this.props.lastMoves[9][1]+d;a.lineWidth=c;c=a.createLinearGradient(0,0,b-a.lineWidth/2,0);c.addColorStop(1,
"rgba(36,42,48,0.1)");c.addColorStop(0,"rgba(36,42,48,0)");a.strokeStyle=c;a.lineCap="round";a.beginPath();a.moveTo(f,k);a.bezierCurveTo(g,e,h,l,b,d);a.stroke()}}};
Player.prototype.updatePosition=function(){if(this.props.locked)this.props.x<this.props.endX&&(this.props.x+=2),this.props.y<this.props.endY&&(this.props.y+=2),this.props.z<this.props.endZ&&(this.props.z+=1),this.props.x>this.props.endX&&(this.props.x-=2),this.props.y>this.props.endY&&(this.props.y-=2),this.props.z>this.props.endZ&&(this.props.z-=1);else{var a=0.1,b=this.props.vector[0]*(Math.PI/180);this.props.z-3>50*this.props.vector[2]?this.props.z-=3:this.props.z+3<50*this.props.vector[2]&&(this.props.z+=
3);this.props.z>this.props.maxZ&&(this.props.z=this.props.maxZ);this.props.z<this.props.minZ&&(this.props.z=this.props.minZ);90<this.props.vector[0]&&270>this.props.vector[0]&&(a*=2);this.props.x+=Math.cos(b)*this.props.vector[1]*a;this.props.x>this.props.maxX&&(this.props.x=this.props.maxX);this.props.x<this.props.minX&&(this.props.x=this.props.minX);a=this.props.z/2;this.props.y+=0.1*Math.sin(b)*this.props.vector[1];this.props.y>this.props.maxY-a&&(this.props.y=this.props.maxY-a);this.props.y<this.props.minY+
a&&(this.props.y=this.props.minY+a)}this.props.lastMoves.push([this.props.x,this.props.y]);10<this.props.lastMoves.length&&this.props.lastMoves.shift()};Player.prototype.updateScore=function(a,b){this.props.score+=a;socket.emit("update-score",{viewerId:viewerId,gameRoom:gameRoom,playerId:this.props.playerId,score:this.props.score,audio:b})};Player.prototype.lockPlayer=function(){this.props.locked=!0};
Player.prototype.loadIcon=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=100;b.height=100;var d=b.width/2;a?c.drawImage(a,0,0,b.width,b.height):(c.fillStyle="rgba(0,0,0,1)",c.fillRect(0,0,b.width,b.height));c.globalCompositeOperation="destination-in";this.drawPolygon(c,d,d,d,8);this.props.icon=b};
Player.prototype.drawPolygon=function(a,b,c,d,f){var k=360/f*(Math.PI/180),g,e;a.beginPath();a.moveTo(Math.cos(h)*d,Math.cos(h)*d);for(var h,l,m=0;m<f;m++)h=m*k,l=b+Math.cos(h)*d,h=c+Math.sin(h)*d,0<m?a.lineTo(l,h):(g=l,e=h),m==f-1&&a.lineTo(g,e);a.closePath();a.fill()};var PlayerShadow=function(a){this.props={player:a.props}};
PlayerShadow.prototype.draw=function(a){if(9<this.props.player.lastMoves.length){var b=-50*(this.props.player.z-this.props.player.minZ)/(this.props.player.maxZ-this.props.player.minZ),c=this.props.player.minZ,d=1.5*this.props.player.z-1.5*c;if(!(5>d)){var f=0+b,k=this.props.player.lastMoves[0][1]+d,g=this.props.player.lastMoves[6][0]+b,e=this.props.player.lastMoves[6][1]+d,h=this.props.player.lastMoves[7][0]+b,l=this.props.player.lastMoves[7][1]+d,b=100+this.props.player.lastMoves[9][0]+b,d=this.props.player.lastMoves[9][1]+
d;a.lineWidth=c;c=a.createLinearGradient(0,0,b-a.lineWidth/2,0);c.addColorStop(1,"rgba(36,42,48,0.1)");c.addColorStop(0,"rgba(36,42,48,0)");a.strokeStyle=c;a.lineCap="round";a.beginPath();a.moveTo(f,k);a.bezierCurveTo(g,e,h,l,b,d);a.stroke()}}};profiler={context:!1,speedLog:[],frameCount:0,frameStartTime:0,fpsLog:[],paintCountLog:[],lastPaintCount:0,target:15,x:0,y:0,graphScale:0.25,start:function(a,b,c,d,f){window.mozPaintCount&&(profiler.lastPaintCount=window.mozPaintCount);profiler.context=a;profiler.x=c;profiler.y=d;profiler.graphScale=f;profiler.target=b;setTimeout(profiler.getStats,1E3)},tick:function(){var a=(new Date).getTime();profiler.frameStartTime&&profiler.speedLog.push(a-profiler.frameStartTime);profiler.frameStartTime=a;profiler.frameCount++;
profiler.drawStats()},getStats:function(){window.mozPaintCount&&(profiler.paintCountLog.push(window.mozPaintCount-profiler.lastPaintCount),profiler.lastPaintCount=window.mozPaintCount);profiler.fpsLog.push(profiler.frameCount);profiler.frameCount=0},drawStats:function(a){var b=profiler.x,c=profiler.y;profiler.context.save();profiler.context.font="normal 10px monospace";profiler.context.textAlign="left";profiler.context.textBaseLine="top";profiler.context.fillStyle="black";profiler.context.fillRect(b,
c-10,120,85);c+=30;b+=10;profiler.context.beginPath();profiler.context.strokeStyle="#888";profiler.context.lineWidth=1.5;profiler.context.moveTo(b,c);profiler.context.lineTo(b+100,c);profiler.context.stroke();profiler.context.moveTo(b,c);profiler.context.lineTo(b,c-25);profiler.context.stroke();profiler.context.strokeStyle="#00ffff";profiler.context.fillStyle="#00ffff";profiler.context.lineWidth=0.3;var d=profiler.speedLog.length,f=50<profiler.speedLog.length?profiler.speedLog.length-50:0;profiler.context.beginPath();
for(var k=0;f<d;f++,k+=2)profiler.context.moveTo(b+k,c),profiler.context.lineTo(b+k,c-profiler.speedLog[f]*profiler.graphScale),profiler.context.stroke();profiler.context.beginPath();profiler.context.strokeStyle="#FF0000";profiler.context.lineWidth=1;d=c-profiler.target*profiler.graphScale;profiler.context.moveTo(b,d);profiler.context.lineTo(b+100,d);profiler.context.stroke();c+=12;if(a){d=0;for(f in profiler.speedLog)d+=profiler.speedLog[f];d=Math.floor(10*(d/profiler.speedLog.length))/10}else d=
profiler.speedLog[profiler.speedLog.length-1];profiler.context.fillText("Render Time: "+d,b,c);profiler.context.fillStyle="#00ff00";c+=12;if(a){fps=0;for(f in profiler.fpsLog)fps+=profiler.fpsLog[f];fps=Math.floor(10*(fps/profiler.fpsLog.length))/10}else fps=profiler.fpsLog[profiler.fpsLog.length-1];profiler.context.fillText(" Canvas FPS: "+fps,b,c);if(window.mozPaintCount){if(a){fps=0;for(f in profiler.paintCountLog)fps+=profiler.paintCountLog[f];fps=Math.floor(10*(fps/profiler.paintCountLog.length))/
10}else fps=profiler.paintCountLog[profiler.paintCountLog.length-1];profiler.context.fillText("Browser FPS: "+fps,b,c+12)}profiler.context.restore()}};if("undefined"===typeof io)$(".main").hide(),$("#error").show(),$("#error-message").html("Can't connect to Multeor server.<br />This could be caused by a blocking firewall or a problem at our end");else if(!Modernizr.sessionstorage||!Modernizr.canvas||!Modernizr.websockets)$(".main").hide(),$("#error").show(),$("#error-message").html('Browser not supported<br />(<a href="/about/#requirements">read more</a>)');else{var canvas=document.getElementById("canvas"),context=canvas.getContext("2d");canvas.width=
window.innerWidth;canvas.height=600;context.globalAlpha=0.5;var socket=io.connect("http://dev.multeor.com:443"),players={},game=!1,playerColors="110,8,157 0,255,247 16,230,34 255,174,26 255,255,0 255,110,221 8,103,255 255,0,36".split(" "),playerColorsShuffled=shuffleArray(playerColors.slice(0)),profilerOn=location.search.match(/profile/)?!0:!1,gameRoom=sessionStorage.getItem("game-room")||Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("game-room",gameRoom);var viewerId=sessionStorage.getItem("viewer-id")||
Math.floor(1E4*Math.random()+1E4);sessionStorage.setItem("viewer-id",viewerId);$(document).ready(function(){var a=new Game("/levels/forest",gameRoom);socket.emit("new-viewer",{viewerId:viewerId,gameRoom:gameRoom});socket.on("game-end",function(b){a.abortGame()});socket.on("game-invalid",function(a){sessionStorage.setItem("viewer-id","");sessionStorage.setItem("game-room","");document.location="/";logGAEvent("Game hijacking?")});socket.on("update-game-state",function(a){var b=0,c;for(c in a.players)b++;
b&&$("#gameStart").removeClass("disabled");b=0;for(c in a.players){var d=a.players[c].playerId;b++;if("undefined"==typeof players[d]){var f=playerColorsShuffled.splice(0,1)[0];players[d]=new Player(context,d,a.players[c].playerIcon,f,b,a.players[c].webAudioSupported);socket.emit("update-player-color",{viewerId:viewerId,gameRoom:gameRoom,playerId:d,playerColor:f})}}for(var m in players){b=!1;for(c in a.players)a.players[c].playerId==m&&(b=!0);b||delete players[m]}});socket.on("player-update",function(a){if("undefined"==
typeof players[a.pid])return!1;players[a.pid].props.vector=a.v});profilerOn&&profiler.start(context,12,245,120,1);var b,c,d=(new Date).getTime(),f=1E3/60;(function g(e){requestAnimationFrame(g);b=(new Date).getTime();c=b-d;c>f&&(d=b-c%f,a&&a.tick(context,c));profilerOn&&(context.drawImage(canvas,0,0),profiler.tick())})();$(".gamecode-container").html(gameRoom);$("#gameStart").off("click").on("click",function(b){b.preventDefault();if($(this).hasClass("disabled"))return!1;hideInstructions();a.getReady()});
$("#gameReset button").off("click").on("click",function(b){b.preventDefault();a.resetGame()})})}
function hideInstructions(){$(".highestScoreEver").fadeOut(250);$.each($(".step"),function(a,b){$(b).delay(200*a).animate({top:"+=346"},function(){if(a==$(".step").length-1)for(var b=200,d=$(".step-header").length-1;0<=d;d--)$(".step-header").eq(d).delay(b).animate({opacity:0}),b+=750})});setTimeout(function(){$(".destroy-container").show();setTimeout(function(){$(".destroy-container").fadeOut(750)},1E3);$(".instructions-container").hide()},3650)}
function showInstructions(){$(".highestScoreEver").show();$(".leaderboard-container").hide();$(".instructions-container").show();$(".step").css({top:0,opacity:0}).animate({opacity:1},300);$(".step-header").animate({opacity:1},300)}function shuffleArray(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function randomFloat(a,b){return a+Math.random()*(b-a)}
function logGAEvent(a,b,c){"undefined"!==typeof _gaq&&("undefined"!==typeof b&&"undefined"!==typeof c?(Upon.log("Viewer, "+a+", "+b+", "+c),_gaq.push(["_trackEvent","Viewer",a,b,c])):_gaq.push(["_trackEvent","Viewer",a]))};
