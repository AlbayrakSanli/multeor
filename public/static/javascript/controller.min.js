var socket=io.connect(window.location.hostname+":843");
$(document).ready(function(){$(window).width();$(window).height();var b=sessionStorage.getItem("player-id")||Math.floor(1E4*Math.random()+1E4),c=parseInt(sessionStorage.getItem("game-room"),10),n=0,p=0,d=1,h=!1,k=0,l="",f=!0,e=JSON.parse(sessionStorage.getItem("facebook-profile"));sessionStorage.setItem("player-id",b);socket.on("disconnect",function(){h=!1;document.location="/controller/"});socket.on("game-invalid",function(a){h=!1;sessionStorage.setItem("player-id","");sessionStorage.setItem("game-room",
"");document.location="/controller/"});socket.on("game-has-started",function(a){$("#score").html("Sorry, game already started")});socket.on("game-full",function(a){$("#score").html("Too many players")});socket.on("player-joined",function(a){h=!0;q();$("#score").html("Waiting for other players")});socket.on("game-reset",function(a){document.location.reload()});socket.on("game-get-ready",function(a){Upon.log("game-get-ready");$("#score").html("Get ready")});socket.on("game-start",function(a){Upon.log("game-start");
$("#score").html(0)});socket.on("game-end",function(a){Upon.log("game-end");h=!1;$("#game-start, #controller").hide();$("#game-end").show();$("#game-end h1 span").html(k);if(e)$("#facebook-share").show().off("click").on("click",function(b){b.preventDefault();fbPublish(k,a.leaderboard)});else $("#facebook-share").hide()});socket.on("update-score",function(a){Upon.log("update-score");$("html,body").css({backgroundColor:"#FFF"});setTimeout(function(){$("html,body").css({backgroundColor:"rgba("+l+",.8)"})},
250);k=a.score;$("#score").html(k)});socket.on("update-player-color",function(a){l=a.playerColor;$("html, body").css({backgroundColor:"rgba("+l+",.8)"});$("#game-start, #game-end").hide();$("#controller").show()});var m=0,r=new Date;setInterval(function(){var a=new Date,b=a-r;1E3<b&&(r=a,a=Math.round(m/(b/1E3),2),$("#message").html(a+" average PPS"),m=0)},500);var q=function(){if(!h)return!1;f&&(socket.emit("player-update",{pid:b,gr:c,v:[Math.floor(n),Math.floor(p),d]}),m++,f=!1);setTimeout(q,20)},
s=function(a,b){var c,e;c=$("#leftControls").width()/3;var g=0,g=b-c,d=a-c;e=Math.sqrt(Math.pow(g,2)+Math.pow(d,2));g=180*Math.asin(g/e)/Math.PI;0>d&&(g=180-g);e>c&&(e=c);n=c=g;p=e;$("#joystick").width(e).css({"-webkit-transform":"rotate("+c+"deg)","-ms-transform":"rotate("+c+"deg)"});f=!0};window.navigator.msPointerEnabled?($("#leftControls").on("MSPointerMove",function(a){a.preventDefault();var b=a.originalEvent.clientX.toFixed(0)-$(this).offset().left;a=a.originalEvent.clientY.toFixed(0)-$(this).offset().top;
s(b,a)}),$("#leftControls").on("MSPointerUp",function(a){$("#joystick").animate({width:5},400)}),$("#rightControls #button").on("MSPointerDown",function(a){a.preventDefault();d=3;f=!0;$(this).toggleClass("pressed")}),$("#rightControls #button").on("MSPointerUp",function(a){a.preventDefault();d=1;f=!0;$(this).toggleClass("pressed")})):($("#leftControls").on("touchmove",function(a){a.preventDefault();var b=a.originalEvent.targetTouches[0].clientX-$(this).offset().left;a=a.originalEvent.targetTouches[0].clientY-
$(this).offset().top;s(b,a)}),$("#leftControls").on("touchend",function(a){$("#joystick").animate({width:5},400)}),$("#rightControls #button").on("touchstart",function(a){a.preventDefault();d=3;f=!0;$(this).toggleClass("pressed")}),$("#rightControls #button").on("touchend",function(a){a.preventDefault();d=1;f=!0;$(this).toggleClass("pressed")}));$("#join-game").on("click",function(){var a=$("input[name=game-code]"),d=parseInt(a.val(),10);isNaN(d)||1E4>d||99999<d?(alert("Not a valid code"),a.val("").focus()):
(sessionStorage.setItem("game-room",d),c=d,socket.emit("new-player",{playerId:b,gameRoom:d,playerIcon:e?e.picture.data.url:!1}))});c&&$("input[name=game-code]").val(c);$("input[name=game-code]").focus();e&&$(".buddy-icon").append('<img src="'+e.picture.data.url+'" /><div>'+e.name+"</div>").show()});(function(b){var c=b.getElementsByTagName("script")[0];b.getElementById("facebook-jssdk")||(b=b.createElement("script"),b.id="facebook-jssdk",b.async=!0,b.src="//connect.facebook.net/en_US/all.js",c.parentNode.insertBefore(b,c))})(document);var facebookConnected=!1;window.fbAsyncInit=function(){FB.init({appId:"312039092260353",status:!0,cookie:!0,xfbml:!0});FB.Event.subscribe("auth.authResponseChange",function(b){"connected"===b.status&&(facebookConnected=!0)})};
function fbLogin(b){FB.login(function(c){"connected"===c.status?b(!0):b(!1)})}function fbGetProfile(b){sessionStorage.getItem("facebook-profile")?b():FB.api("/me?fields=id,name,picture",function(c){sessionStorage.setItem("facebook-profile",JSON.stringify(c));console.log(c);b()})}function fbLoggedIn(){return facebookConnected}
function fbPublish(b,c){FB.ui({display:"touch",method:"stream.publish",name:"I played Multeor and I scored "+b+" points!",href:"http://multeor.com",caption:"Multeor - a multiplayer webgame",description:"Use a mobile to pilot your meteor. Make sure you leave the biggest trail of destruction.",link:"http://multeor.com",action_links:[{text:"Play",href:"http://multeor.com"}],picture:c},function(b){b&&b.post_id?alert("Post was published."):alert("Post was not published.")})};
