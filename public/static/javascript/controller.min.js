if("undefined"===typeof io||!Modernizr.sessionstorage||!Modernizr.websockets)$("#game-start, #game-end, #controller").hide(),$("#error").show();else{var socket=io.connect(window.location.hostname+":843");$(document).ready(function(){$(window).width();$(window).height();var b=sessionStorage.getItem("player-id")||Math.floor(1E4*Math.random()+1E4),c=parseInt(sessionStorage.getItem("game-room"),10),k=0,q=0,d=1,g=!1,l=0,n="",h=!0,m=JSON.parse(sessionStorage.getItem("facebook-profile"));sessionStorage.setItem("player-id",
b);socket.on("disconnect",function(){sessionStorage.setItem("player-id","");sessionStorage.setItem("game-room","");document.location.reload()});socket.on("game-has-started",function(a){$("#message").html("Unable to join, game already started")});socket.on("game-full",function(a){$("#message").html("Unable to join, game is full")});socket.on("game-not-available",function(a){sessionStorage.setItem("game-room","");$("input[name=game-code]").val("");$("#message").html("Unable to join, game not available<br />try again...")});
socket.on("game-invalid",function(a){g&&(sessionStorage.setItem("game-room",""),document.location.reload())});socket.on("player-joined",function(a){g=!0;r();$("#score").html("Press Start!")});socket.on("game-get-ready",function(a){Upon.log("game-get-ready");$("#score").html("Get ready")});socket.on("game-start",function(a){Upon.log("game-start");$("#score").html(0)});socket.on("game-end",function(a){Upon.log("game-end");g=!1;$("#game-start, #controller").hide();$("#game-end").show();$("#game-end h1 span").html(l);
$("#facebook-share a").on("click",function(a){a.preventDefault();fbPublish(l,"http://multeor.com/static/images/opengraph-200x120.png",function(a){a&&$("#facebook-share").hide()})})});socket.on("update-score",function(a){Upon.log("update-score");$("#controller").css({backgroundColor:"#FFF"});setTimeout(function(){$("#controller").css({backgroundColor:"rgba("+n+",1)"})},250);l=a.score;$("#score").html(l)});socket.on("update-player-color",function(a){n=a.playerColor;$("#controller").css({backgroundColor:"rgba("+
n+",1)"});$("#game-start, #game-end").hide();$("#controller").show()});var p=0,s=new Date;setInterval(function(){var a=new Date,b=a-s;1E3<b&&(s=a,Math.round(p/(b/1E3),2),p=0)},500);var r=function(){if(!g)return!1;h&&(socket.emit("player-update",{pid:b,gr:c,v:[Math.floor(k),Math.floor(q),d]}),p++,h=!1);setTimeout(r,20)},t=function(a,b){var c,e,f;c=$("#joystick").width()/3;f=$("#leftControls").width()/2;var d=$("#leftControls").height()/2;e=0;e=b-d;d=a-f;f=Math.sqrt(Math.pow(e,2)+Math.pow(d,2));e/=
f;var g=Math.asin(e);e=180*Math.asin(e)/Math.PI;0>d&&(e=180-e,g=Math.PI-g);f>c&&(f=c);c=e;e=g;b=Math.sin(e)*f;a=Math.cos(e)*f;k=c;q=f;$("#stick").css({left:a,top:b});h=!0};window.navigator.msPointerEnabled?($("#leftControls").on("MSPointerMove",function(a){a.preventDefault();var b=a.originalEvent.clientX.toFixed(0)-$(this).offset().left;a=a.originalEvent.clientY.toFixed(0)-$(this).offset().top;t(b,a)}),$("#leftControls").on("MSPointerUp",function(a){$("#stick").animate({left:0,top:0},250)}),$("#rightControls #boost").on("MSPointerDown",
function(a){a.preventDefault();d=3;h=!0;$(this).toggleClass("pressed")}),$("#rightControls #boost").on("MSPointerUp",function(a){a.preventDefault();d=1;h=!0;$(this).toggleClass("pressed")})):($("#leftControls").on("touchmove",function(a){a.preventDefault();t(a.originalEvent.targetTouches[0].clientX,a.originalEvent.targetTouches[0].clientY)}),$("#leftControls").on("touchend",function(a){$("#stick").animate({left:0,top:0},250)}),$("#rightControls").on("touchstart",function(a){a.preventDefault();d=3;
h=!0;$("#boostBg").addClass("pressed")}),$("#rightControls").on("touchend",function(a){a.preventDefault();d=1;h=!0;$("#boostBg").removeClass("pressed")}));$("input[name=game-code]").on("blur",function(){$("#join-game button").trigger("click")});$("#join-game").removeClass("disabled");$("#join-game button").text("Join Game").on("click",function(a){a.preventDefault();a=$("input[name=game-code]");if(0<a.val().length){var d=parseInt(a.val(),10);isNaN(d)||1E4>d||99999<d?($("#message").html("Game code invalid<br />try again..."),
a.val("")):(sessionStorage.setItem("game-room",d),c=d,socket.emit("new-player",{playerId:b,gameRoom:d,playerIcon:m?m.picture.data.url:!1}))}});$("#game-reset a").on("click",function(a){a.preventDefault();document.location.reload()});c&&$("input[name=game-code]").val(c);$("input[name=game-code]").focus();m?($("#game-start, #game-end").removeClass("anon"),$(".buddy-icon").css({backgroundImage:"url("+m.picture.data.url+")"})):$("#game-start, #game-end").addClass("anon");$("#game-start").show()})};(function(b){var c=b.getElementsByTagName("script")[0];b.getElementById("facebook-jssdk")||(b=b.createElement("script"),b.id="facebook-jssdk",b.async=!0,b.src="//connect.facebook.net/en_US/all.js",c.parentNode.insertBefore(b,c))})(document);var facebookConnected=!1;window.fbAsyncInit=function(){FB.init({appId:"312039092260353",status:!0,cookie:!0,xfbml:!0});FB.Event.subscribe("auth.authResponseChange",function(b){"connected"===b.status&&(facebookConnected=!0)})};
function fbLogin(b){FB.login(function(c){"connected"===c.status?b(!0):b(!1)})}function fbGetProfile(b){sessionStorage.getItem("facebook-profile")?b():FB.api("/me?fields=id,name,picture",function(c){sessionStorage.setItem("facebook-profile",JSON.stringify(c));console.log(c);b()})}function fbLoggedIn(){return facebookConnected}
function fbPublish(b,c,k){FB.ui({display:"popup",method:"feed",name:"I played Multeor and scored "+b+" points!",href:"http://multeor.com",caption:"Multeor - a multiplayer webgame",description:"Use your mobile to pilot a meteor leaving the biggest trail of destruction (up to 8 players)",link:"http://multeor.com",picture:c},function(b){b&&b.post_id?k(!0):k(!1)})};
