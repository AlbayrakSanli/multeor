if("undefined"===typeof io)$("#game-start, #game-end, #controller").hide(),$("#error").show(),$("#error-message").html("Can't connect to Multeor server");else if(0<navigator.userAgent.indexOf("FBAN")&&0<navigator.userAgent.indexOf("FBAV"))$("#game-start, #game-end, #controller").hide(),$("#error").show(),$("#error-message").html("Sadly the Facebook in-app browser isn't supported. Go to "+window.location.hostname+" with a different mobile browser to play");else if(!Modernizr.sessionstorage||!Modernizr.websockets)$("#game-start, #game-end, #controller").hide(),
$("#error").show(),$("#error-message").html('Device not supported<br />(<a href="/about/#requirements">read more</a>)');else{sessionStorage.getItem("came-from-title-screen")||(document.location="/");var socket=io.connect("http://dev.multeor.com:443");$(document).ready(function(){$(window).width();$(window).height();var c=sessionStorage.getItem("player-id")||Math.floor(1E4*Math.random()+1E4),b=parseInt(sessionStorage.getItem("game-room"),10),q=0,r=0,k=1,l=!1,f=0,m="",h=!0,s=!1,g=JSON.parse(sessionStorage.getItem("facebook-profile"));
sessionStorage.setItem("player-id",c);socket.on("disconnect",function(){sessionStorage.setItem("player-id","");sessionStorage.setItem("game-room","");document.location.reload()});socket.on("game-has-started",function(a){$("#message").html("Unable to join, game already started")});socket.on("game-full",function(a){$("#message").html("Unable to join, game is full")});socket.on("game-not-available",function(a){sessionStorage.setItem("game-room","");$("input[name=game-code]").val("");$("#message").html("Unable to join, game not available<br />try again...")});
socket.on("game-invalid",function(a){l&&(sessionStorage.setItem("game-room",""),document.location.reload())});socket.on("player-joined",function(a){l=!0;t();$("#score").html("Synced")});socket.on("game-get-ready",function(a){Upon.log("game-get-ready");$("#score").html("Get ready")});socket.on("game-start",function(a){Upon.log("game-start");$("#score").html(0)});socket.on("game-end",function(a){if(!l)return!1;Upon.log("game-end");l=!1;if(a.highScore){var d="Playing Multeor I scored a new highscore of "+
f+" points!";a="<h1>Awesome, you scored a new highscore: <span>"+f+"</span></h1>";var c="http://multeor.com/static/images/opengraph-600x600-highscore.png"}else d="Playing Multeor I scored "+f+" points!",a="<h1>Good job, you scored: <span>"+f+"</span></h1>",c="http://multeor.com/static/images/opengraph-600x600.png";$("#game-start, #controller").hide();$("#game-end").fadeIn(1E3);$("#game-end .you-scored-text").html(a);$("#facebook-share a").on("click",function(a){a.preventDefault();fbPublish(d,c,function(a){a&&
$("#facebook-share").hide()})})});socket.on("update-score",function(a){Upon.log("update-score");$("#controller").css({backgroundColor:"#FFF"});setTimeout(function(){$("#controller").css({backgroundColor:"rgba("+m+",1)"})},250);f=a.score;$("#score").html(f);play(1,a.audio)});socket.on("update-player-color",function(a){m=a.playerColor;$("#controller").css({backgroundColor:"rgba("+m+",1)"});$("#game-start, #game-end").hide();$("#controller").show()});var n=0,u=new Date;setInterval(function(){var a=new Date,
d=a-u;1E3<d&&(u=a,Math.round(n/(d/1E3),2),n=0)},500);var t=function(){if(!l)return!1;h&&(socket.emit("player-update",{pid:c,gr:b,v:[Math.floor(q),Math.floor(r),k]}),n++,h=!1);setTimeout(t,20)},v=function(a,d){var c,e,b;c=$("#joystick").width()/3;b=$("#leftControls").width()/2;var f=$("#leftControls").height()/2;e=0;e=d-f;f=a-b;b=Math.sqrt(Math.pow(e,2)+Math.pow(f,2));e/=b;var g=Math.asin(e);e=180*Math.asin(e)/Math.PI;0>f&&(e=180-e,g=Math.PI-g);b>c&&(b=c);c=e;e=g;d=Math.sin(e)*b;a=Math.cos(e)*b;q=
c;r=b;$("#stick").css({left:a,top:d});h=!0};window.navigator.msPointerEnabled?($("#leftControls").on("MSPointerMove",function(a){a.preventDefault();var b=a.originalEvent.clientX.toFixed(0)-$(this).offset().left;a=a.originalEvent.clientY.toFixed(0)-$(this).offset().top;v(b,a)}),$("#leftControls").on("MSPointerUp",function(a){$("#stick").animate({left:0,top:0},250)}),$("#rightControls #boost").on("MSPointerDown",function(a){a.preventDefault();k=3;h=!0;$(this).toggleClass("pressed")}),$("#rightControls #boost").on("MSPointerUp",
function(a){a.preventDefault();k=1;h=!0;$(this).toggleClass("pressed")})):($("#leftControls").on("touchstart",function(a){play(0);$("#leftControls").off("touchstart")}),$("#leftControls").on("touchmove",function(a){a.preventDefault();v(a.originalEvent.targetTouches[0].clientX,a.originalEvent.targetTouches[0].clientY)}),$("#leftControls").on("touchend",function(a){$("#stick").animate({left:0,top:0},250)}),$("#rightControls").on("touchstart",function(a){a.preventDefault();k=3;h=!0;$("#boost").addClass("pressed")}),
$("#rightControls").on("touchend",function(a){a.preventDefault();k=1;h=!0;$("#boost").removeClass("pressed")}));$("input[name=game-code]").on("blur",function(){$("#join-game button").trigger("click")});$("#join-game").removeClass("disabled");$("#join-game button").text("Join Game").on("click",function(a){a.preventDefault();a=$("input[name=game-code]");if(0<a.val().length){var d=parseInt(a.val(),10);isNaN(d)||1E4>d||99999<d?($("#message").html("Game code invalid<br />try again..."),a.val("")):(sessionStorage.setItem("game-room",
d),b=d,socket.emit("new-player",{playerId:c,gameRoom:d,playerIcon:g?g.picture.data.url:!1,playerName:g?g.name:!1,webAudioSupported:s}))}});$("#game-reset a").on("click",function(a){a.preventDefault();document.location.reload()});b&&$("input[name=game-code]").val(b);$("input[name=game-code]").focus();g?($("#game-start, #game-end").removeClass("anon"),$(".buddy-icon").css({backgroundImage:"url("+g.picture.data.url+")"})):$("#game-start, #game-end").addClass("anon");$("#game-start").show();if("webkitAudioContext"in
window){s=!0;myAudioContext=new webkitAudioContext;volume=myAudioContext.createGainNode();volume.gain.value=1;volume.connect(myAudioContext.destination);var p="mp3";"probably"==document.createElement("audio").canPlayType('audio/ogg; codecs="vorbis"')&&(p="ogg");request=new XMLHttpRequest;request._fileName="bonus";request.open("GET","/levels/forest/audio/sprites/bonus."+p,!0);request.responseType="arraybuffer";request.addEventListener("load",bufferSound,!1);request.send();request=new XMLHttpRequest;
request._fileName="explosion";request.open("GET","/levels/forest/audio/sprites/explosion."+p,!0);request.responseType="arraybuffer";request.addEventListener("load",bufferSound,!1);request.send()}setTimeout(function(){window.scrollTo(0,1)},0)})}var myAudioContext,mySource,volume,request,buffers={};function bufferSound(c){c=c.target;var b=myAudioContext.createBuffer(c.response,!1);buffers[c._fileName]=b}
function play(c,b){"undefined"===typeof b&&(b="bonus");mySource=myAudioContext.createBufferSource();mySource.buffer=buffers[b];volume.gain.value=c;mySource.connect(volume);mySource.noteOn(0)};
