if("undefined"===typeof io)$("#game-start, #game-end, #controller").hide(),$("#error").show(),$("#error-message").html("Can't connect to Multeor server");else if(!Modernizr.sessionstorage||!Modernizr.websockets||!Modernizr.touch)$("#game-start, #game-end, #controller").hide(),$("#error").show(),$("#error-message").html('Device not supported<br />(<a href="/about/#requirements">read more</a>)');else{sessionStorage.getItem("came-from-title-screen")||(document.location="/");var socket=io.connect(window.location.hostname+
":443");$(document).ready(function(){$(window).width();$(window).height();var m=sessionStorage.getItem("player-id")||Math.floor(1E4*Math.random()+1E4),l=parseInt(sessionStorage.getItem("game-room"),10),q=0,r=0,f=1,k=!1,d=0,n="",h=!0,e=JSON.parse(sessionStorage.getItem("facebook-profile"));sessionStorage.setItem("player-id",m);socket.on("disconnect",function(){sessionStorage.setItem("player-id","");sessionStorage.setItem("game-room","");document.location.reload()});socket.on("game-has-started",function(a){$("#message").html("Unable to join, game already started")});
socket.on("game-full",function(a){$("#message").html("Unable to join, game is full")});socket.on("game-not-available",function(a){sessionStorage.setItem("game-room","");$("input[name=game-code]").val("");$("#message").html("Unable to join, game not available<br />try again...")});socket.on("game-invalid",function(a){k&&(sessionStorage.setItem("game-room",""),document.location.reload())});socket.on("player-joined",function(a){k=!0;s();$("#score").html("Synced")});socket.on("game-get-ready",function(a){Upon.log("game-get-ready");
$("#score").html("Get ready")});socket.on("game-start",function(a){Upon.log("game-start");$("#score").html(0)});socket.on("game-end",function(a){if(!k)return!1;Upon.log("game-end");k=!1;if(a.highScore){var b="Playing Multeor I scored a new highscore of "+d+" points!";a="<h1>Awesome, you scored a new highscore: <span>"+d+"</span></h1>"}else b="Playing Multeor I scored "+d+" points!",a="<h1>Good job, you scored: <span>"+d+"</span></h1>";$("#game-start, #controller").hide();$("#game-end").fadeIn(1E3);
$("#game-end .you-scored-text").html(a);$("#facebook-share a").on("click",function(a){a.preventDefault();fbPublish(b,"http://multeor.com/static/images/opengraph-600x600.png",function(a){a&&$("#facebook-share").hide()})})});socket.on("update-score",function(a){Upon.log("update-score");$("#controller").css({backgroundColor:"#FFF"});setTimeout(function(){$("#controller").css({backgroundColor:"rgba("+n+",1)"})},250);d=a.score;$("#score").html(d)});socket.on("update-player-color",function(a){n=a.playerColor;
$("#controller").css({backgroundColor:"rgba("+n+",1)"});$("#game-start, #game-end").hide();$("#controller").show()});var p=0,t=new Date;setInterval(function(){var a=new Date,b=a-t;1E3<b&&(t=a,Math.round(p/(b/1E3),2),p=0)},500);var s=function(){if(!k)return!1;h&&(socket.emit("player-update",{pid:m,gr:l,v:[Math.floor(q),Math.floor(r),f]}),p++,h=!1);setTimeout(s,20)},u=function(a,b){var d,c,g;d=$("#joystick").width()/3;g=$("#leftControls").width()/2;var e=$("#leftControls").height()/2;c=0;c=b-e;e=a-
g;g=Math.sqrt(Math.pow(c,2)+Math.pow(e,2));c/=g;var f=Math.asin(c);c=180*Math.asin(c)/Math.PI;0>e&&(c=180-c,f=Math.PI-f);g>d&&(g=d);d=c;c=f;b=Math.sin(c)*g;a=Math.cos(c)*g;q=d;r=g;$("#stick").css({left:a,top:b});h=!0};window.navigator.msPointerEnabled?($("#leftControls").on("MSPointerMove",function(a){a.preventDefault();var b=a.originalEvent.clientX.toFixed(0)-$(this).offset().left;a=a.originalEvent.clientY.toFixed(0)-$(this).offset().top;u(b,a)}),$("#leftControls").on("MSPointerUp",function(a){$("#stick").animate({left:0,
top:0},250)}),$("#rightControls #boost").on("MSPointerDown",function(a){a.preventDefault();f=3;h=!0;$(this).toggleClass("pressed")}),$("#rightControls #boost").on("MSPointerUp",function(a){a.preventDefault();f=1;h=!0;$(this).toggleClass("pressed")})):($("#leftControls").on("touchmove",function(a){a.preventDefault();u(a.originalEvent.targetTouches[0].clientX,a.originalEvent.targetTouches[0].clientY)}),$("#leftControls").on("touchend",function(a){$("#stick").animate({left:0,top:0},250)}),$("#rightControls").on("touchstart",
function(a){a.preventDefault();f=3;h=!0;$("#boost").addClass("pressed")}),$("#rightControls").on("touchend",function(a){a.preventDefault();f=1;h=!0;$("#boost").removeClass("pressed")}));$("input[name=game-code]").on("blur",function(){$("#join-game button").trigger("click")});$("#join-game").removeClass("disabled");$("#join-game button").text("Join Game").on("click",function(a){a.preventDefault();a=$("input[name=game-code]");if(0<a.val().length){var b=parseInt(a.val(),10);isNaN(b)||1E4>b||99999<b?
($("#message").html("Game code invalid<br />try again..."),a.val("")):(sessionStorage.setItem("game-room",b),l=b,socket.emit("new-player",{playerId:m,gameRoom:b,playerIcon:e?e.picture.data.url:!1,playerName:e?e.name:!1}))}});$("#game-reset a").on("click",function(a){a.preventDefault();document.location.reload()});l&&$("input[name=game-code]").val(l);$("input[name=game-code]").focus();e?($("#game-start, #game-end").removeClass("anon"),$(".buddy-icon").css({backgroundImage:"url("+e.picture.data.url+
")"})):$("#game-start, #game-end").addClass("anon");$("#game-start").show()})};
